<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta property="og:type" content="website">
    <meta property="og:title" content="ê¹€ë…•í˜ì´ (GIMNYEONG PAY)">
    <meta property="og:description" content="íƒ„ì†Œì¤‘ë¦½ ì‹¤ì²œ ë° í”Œë¡œê¹… í™œë™ìœ¼ë¡œ ë‚˜ë§Œì˜ ì—ì½” í¬ì¸íŠ¸ë¥¼ ìŒ“ì•„ë³´ì„¸ìš”. ğŸŒ±">
    <meta property="og:image" content="/og-image.png">
    <title>ê¹€ë…•í˜ì´</title>
    <style>
        body, html { margin:0; padding:0; height:100%; overflow:hidden; background:#f7fbfc; }
        iframe { border:none; width:100%; height:100%; display: block; position: absolute; top:0; left:0; }
    </style>
    
    <script>
        /** [1] ì£¼ì†Œì°½ ë°©ì–´ **/
        if (window.location.hostname.includes('googleusercontent.com')) {
            window.location.replace('https://gnpay.my');
        }

        /** [2] ì„¸ì…˜ ë°ì´í„° ì¤€ë¹„ **/
        const baseUrl = "https://script.google.com/macros/s/AKfycbytgcHHzaZTkp6e1XWBXBVNVFRE8bzgE2i6EI9N3k3Vv0FAyCmv9sfDa1_o212bd94U/exec";
        let savedData = null;
        let finalUrl = baseUrl;

        try {
            const saved = localStorage.getItem('k_user');
            if (saved) {
                savedData = JSON.parse(saved);
                if (savedData && savedData.email) {
                    // 1ì°¨ ì£¼ì…: URL íŒŒë¼ë¯¸í„°ì— ì´ë©”ì¼ ë°•ê¸°
                    finalUrl = baseUrl + "?u=" + encodeURIComponent(savedData.email) + "&v=" + Date.now();
                }
            }
        } catch(e) { console.error(e); }
    </script>
</head>
<body>

<script>
    /** [3] iframe ìƒì„± **/
    document.write(`
        <iframe id="appFrame" 
            src="${finalUrl}" 
            allow="camera; microphone; storage-access" 
            sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation" 
            allowfullscreen>
        </iframe>
    `);

    /** [4] í•‘í í†µì‹  ë¡œì§ (ë¡œê·¸ì¸ ìœ ì§€ì˜ í•µì‹¬) **/
    window.addEventListener('message', function(e) {
        const frame = document.getElementById('appFrame');
        
        // ìì‹ì´ "ë‚˜ ë¡œë“œëì–´, ì •ë³´ ì¤˜!" ë¼ê³  ìš”ì²­í•  ë•Œ (GET_SESSION)
        if (e.data.type === 'GET_SESSION') {
            if (savedData) {
                // 2ì°¨ ì£¼ì…: postMessageë¡œ ì„¸ì…˜ ë°ì´í„° ì§ì ‘ ì „ì†¡
                frame.contentWindow.postMessage({ type: 'SEND_SESSION', data: savedData }, '*');
                console.log("ìì‹ì—ê²Œ ì„¸ì…˜ ë°ì´í„° ì „ì†¡ ì™„ë£Œ");
            }
        } 
        
        // ìì‹ì´ ë¡œê·¸ì¸ì„ ìƒˆë¡œ í–ˆì„ ë•Œ ì •ë³´ ì €ì¥ (SAVE_USER)
        else if (e.data.type === 'SAVE_USER' && e.data.data) {
            localStorage.setItem('k_user', JSON.stringify(e.data.data));
            savedData = e.data.data; // ë©”ëª¨ë¦¬ ê°±ì‹ 
            console.log("ìƒˆë¡œìš´ ì„¸ì…˜ ì •ë³´ ì €ì¥ ì™„ë£Œ");
        } 
        
        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        else if (e.data.type === 'LOGOUT') {
            localStorage.removeItem('k_user');
            savedData = null;
            window.location.replace('https://gnpay.my');
        }
    });
</script>
</body>
</html>
