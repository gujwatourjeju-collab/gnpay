<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">

<!-- âœ… iOS ì¶•ì†Œ ë²„ê·¸ ìˆ˜ì •ëœ viewport -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<title>ê¹€ë…•í˜ì´</title>

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #f7fbfc;
}

/* âœ… iOS ì¶•ì†Œ ë°©ì§€ */
iframe {
    border: none;
    width: 100vw;
    height: 100vh;
    display: block;
}
</style>

<script>
/* ===============================
   ì£¼ì†Œì°½ ë°©ì–´ (í•„ìˆ˜ ìœ ì§€)
================================ */
if (window.location.hostname.includes('googleusercontent.com')) {
    window.location.replace('https://gnpay.my');
}

window.onpagehide = function () {
    history.replaceState(null, null, location.href);
};

/* ===============================
   ê¸°ë³¸ ì„¤ì •
================================ */
const baseUrl = "https://script.google.com/macros/s/AKfycbytgcHHzaZTkp6e1XWBXBVNVFRE8bzgE2i6EI9N3k3Vv0FAyCmv9sfDa1_o212bd94U/exec";
let currentUser = null;

/* ===============================
   ì„¸ì…˜ ë™ê¸°í™” (ì™„ì „ ìœ ì§€)
================================ */
window.addEventListener('message', function(e) {

    if (!e.data || !e.data.type) return;

    // ğŸ”’ origin ì²´í¬
    if (!e.origin.includes("google.com")) return;

    /* 1ï¸âƒ£ iframe â†’ ë¶€ëª¨ : ì„¸ì…˜ ìš”ì²­ */
    if (e.data.type === 'GET_SESSION') {
        const saved = localStorage.getItem('k_user');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                e.source.postMessage({ type: 'SEND_SESSION', data: data }, e.origin);
            } catch(err){}
        }
    }

    /* 2ï¸âƒ£ iframe â†’ ë¶€ëª¨ : ë¡œê·¸ì¸ ì„±ê³µ */
    if (e.data.type === 'SAVE_USER') {
        localStorage.setItem('k_user', JSON.stringify(e.data.data));
        currentUser = e.data.data;
        console.log("ë¶€ëª¨ì— ì„¸ì…˜ ì €ì¥ ì™„ë£Œ:", currentUser.email);
    }

    /* 3ï¸âƒ£ iframe â†’ ë¶€ëª¨ : ë¡œê·¸ì•„ì›ƒ */
    if (e.data.type === 'LOGOUT') {
        localStorage.removeItem('k_user');
        currentUser = null;
        console.log("ë¶€ëª¨ ì„¸ì…˜ ì‚­ì œ ì™„ë£Œ");
    }
});

/* ===============================
   iframe ìƒì„±
================================ */
function createIframe() {

    let src = baseUrl;

    const saved = localStorage.getItem('k_user');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            if (data && data.email) {
                src += "?u=" + encodeURIComponent(data.email) + "&v=" + Date.now();
                currentUser = data;
                console.log("ìë™ ë¡œê·¸ì¸ ì‹œë„:", data.email);
            }
        } catch(e){}
    }

    const iframe = document.createElement('iframe');
    iframe.id = "appFrame";
    iframe.src = src;

    /* âœ… ì¹´ë©”ë¼ ê¶Œí•œ ìœ ì§€ */
    iframe.allow = "camera; microphone; storage-access";
    iframe.setAttribute("allowfullscreen", "");

    document.body.appendChild(iframe);
}

window.addEventListener('load', createIframe);
</script>
</head>
<body>
</body>
</html>
