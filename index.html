<!DOCTYPE html>
<html lang="ko">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>김녕페이 2.0</title>
    <link rel="icon" href="https://gnpay.my/log.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
    :root { --primary: #01b2ad; --primary-grad: linear-gradient(135deg, #01b2ad 0%, #00d2ff 100%); --bg-grad: linear-gradient(180deg, #e6f7f6 0%, #f8fcfc 40%, #ffffff 100%); }
    
    body { font-family: 'Pretendard', sans-serif; background: var(--bg-grad); margin:0; padding: env(safe-area-inset-top, 10px) 0 100px 0; min-height: 100vh; color: #1a1a1a; overflow-x: hidden; position: relative; }
    
    .top-nav { display: flex; justify-content: space-between; align-items: flex-start; padding: 20px 20px 5px; } 
    .auth-links { display: flex; gap: 5px; align-items: center; }
    .auth-link { font-size: 0.8rem; font-weight: 700; color: #888; text-decoration: none; cursor: pointer; padding: 5px; line-height: 1; }
    
    /* 메인 대시보드 숨쉬기 */
    .dashboard-card { 
        background: white; margin: 0 20px 15px; padding: 20px; border-radius: 24px; 
        display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        position: relative; animation: breathe 2s infinite ease-in-out; transition: transform 0.2s ease;
        border: 1px solid rgba(1, 178, 173, 0.1);
    }
    
    @keyframes breathe {
        0% { transform: scale(1); box-shadow: 0 10px 25px rgba(1, 178, 173, 0.15); }
        50% { transform: scale(1.04); box-shadow: 0 0 35px rgba(1, 178, 173, 0.5), 0 10px 40px rgba(0, 210, 255, 0.3); }
        100% { transform: scale(1); box-shadow: 0 10px 25px rgba(1, 178, 173, 0.15); }
    }

    .amount-text { font-size: 1.8rem; font-weight: 900; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    /* [수정] 마이페이지 프리미엄 카드 및 일체형 QR 디자인 */
    .premium-card {
        background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
        border-radius: 35px; padding: 50px 20px 35px; margin: 20px; color: white;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3); position: relative; overflow: hidden;
        border: 1px solid rgba(255,255,255,0.05);
    }

    /* 로고와 QR을 하나로 묶어 숨쉬게 하는 컨테이너 */
    .qr-integration-box {
        position: relative; display: inline-block; margin-bottom: 25px;
        animation: qr-breathe 2s infinite ease-in-out; /* 통합 숨쉬기 */
    }

    .qr-frame {
        background: white; padding: 15px; border-radius: 24px; display: inline-block;
        box-shadow: 0 0 20px rgba(1, 178, 173, 0.4);
    }

    /* 로고 상단 중앙 침범 배치 */
    .qr-top-logo {
        position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
        width: 55px; height: 55px; background: var(--primary-grad);
        border-radius: 18px; border: 3px solid #1a1a1a; /* 카드 배경과 맞춘 테두리로 침범 강조 */
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 10;
        padding: 5px;
    }

    @keyframes qr-breathe {
        0% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(1, 178, 173, 0.3)); }
        50% { transform: scale(1.05); filter: drop-shadow(0 0 25px rgba(1, 178, 173, 0.7)); }
        100% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(1, 178, 173, 0.3)); }
    }

    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 20px; margin-bottom: 15px; }
    .menu-item { background: white; padding: 15px 10px; text-align: center; border-radius: 20px; border: 1px solid #eee; cursor: pointer; }
    .menu-item i { font-size: 1.5rem; margin-bottom: 3px; display: inline-block; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .menu-item .menu-title { font-size: 0.85rem; font-weight: 800; color: #333; }

    .btn-scan { width: 100%; padding: 15px; border-radius: 20px; font-weight: 800; border: none; color: white; background: var(--primary-grad); box-shadow: 0 8px 20px rgba(1, 178, 173, 0.25); display: flex; align-items: center; justify-content: center; gap: 10px; }
    .fixed-footer-nav { position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 1000; }
    
    .history-img { width: 100%; max-height: 180px; object-fit: cover; border-radius: 12px; margin-top: 8px; border: 1px solid #eee; display: block; }
    .history-content { font-size: 0.8rem; color: #555; background: #f8f9fa; padding: 10px; border-radius: 10px; margin-top: 8px; }

    .page { display: none; width: 100%; animation: fadeIn 0.3s ease-in-out; }
    .active { display: block !important; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .badge-status { padding: 5px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
    .badge-pending { background: #fff3cd; color: #856404; }
    .badge-approved { background: #d4edda; color: #155724; }
    .badge-rejected { background: #f8d7da; color: #721c24; }
    
    .custom-input { border: none; border-radius: 16px; background: white; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 15px; width: 100%; }
    .form-label { font-size: 0.8rem; font-weight: 700; color: #666; margin-left: 5px; margin-bottom: 5px; }
</style>
</head>
<body>

    <div id="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 10000; display: none; justify-content: center; align-items: center; flex-direction: column;">
        <div class="spinner-border text-info" role="status"></div>
        <div class="mt-3 fw-bold" style="color:var(--primary)">처리 중입니다...</div>
    </div>

    <div id="qr-focus-layer" onclick="this.style.display='none'" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center;">
        <div class="bg-white p-4 rounded-5 text-center shadow-lg" style="width:85%; max-width:350px;" onclick="event.stopPropagation()">
            <div class="fw-bold mb-3" style="color:var(--primary)">GIMNYEONG PASS</div>
            <div class="qr-wrapper" style="position: relative; width: 100%; display: flex; justify-content: center; align-items: center;">
                <img id="qr-img-large" src="" style="width: 100%; border-radius: 20px;">
                <div class="qr-logo-box" style="position: absolute; width: 60px; height: 60px; background: var(--primary-grad); border-radius: 16px; border: 2px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); overflow: hidden; display: flex; align-items: center; justify-content: center;"><img src="https://gnpay.my/log2.png" style="width:100%;"></div>
            </div>
            <div class="mt-4">
                <div class="amount-text user-points-display" id="focus-points">0</div>
                <div class="small text-muted fw-bold">나의 에코 포인트</div>
            </div>
        </div>
    </div>

    <div id="page-main" class="page active">
        <div class="top-nav">
            <div>
                <img src="https://gnpay.my/log.png" style="width: 85px; margin-bottom: 8px;">
                <div style="color:var(--primary); font-weight:900; font-size:1.4rem; letter-spacing:-0.5px; margin-bottom: 5px; margin-left: 10px;">김녕페이 2.0</div>
            </div>
            <div class="auth-links" id="auth-area"></div>
        </div>
        <div class="pb-4" style="padding-left: 35px; padding-right: 25px;">
            <h1 class="fw-bolder mt-2" id="welcome-message">함께 만드는<br><strong>푸른 김녕 Wave</strong></h1>
        </div>
        
        <div class="dashboard-card" id="qr-trigger">
            <div><div class="small fw-bold text-muted">MY POINTS</div><div class="amount-text user-points-display" id="main-u-points">0</div></div>
            <div style="background: var(--primary-grad); color:white; width:50px; height:50px; border-radius:18px; display:flex; align-items:center; justify-content:center; font-size:1.5rem;"><i class="bi bi-qr-code"></i></div>
        </div>
        
        <div class="menu-grid">
            <div class="menu-item" onclick="openSubmit('우리 마을 플로깅 (자유)', 2000, '김녕마을 환경 정화에 동참해 주셔서 감사합니다.<br>활동 사진을 자유롭게 올려주세요.')">
                <i class="bi bi-patch-check-fill"></i>
                <div class="menu-title">정화 활동</div>
            </div>
            <div class="menu-item" onclick="alert('가맹점 기능은 준비 중입니다.')">
                <i class="bi bi-bag-heart-fill"></i>
                <div class="menu-title">가맹점</div>
            </div>
            <div class="menu-item" onclick="showPage('page-activities')">
                <i class="bi bi-calendar-check-fill"></i>
                <div class="menu-title">진행중 활동</div>
            </div>
            <div class="menu-item" onclick="showPage('page-guide')">
                <i class="bi bi-info-circle-fill"></i>
                <div class="menu-title">앱사용 안내</div>
            </div>
        </div>
        
        <div class="fixed-footer-nav"><button class="btn-scan" onclick="handleScan()"><i class="bi bi-camera-fill fs-4"></i> 인증용 QR 스캔하기</button></div>
    </div>

    <div id="page-mypage" class="page">
        <div class="top-nav">
            <div class="fw-bold text-secondary" style="cursor:pointer; padding:10px;" onclick="showPage('page-main')"><i class="bi bi-chevron-left"></i> 홈으로</div>
            <div style="color:var(--primary); font-weight:900; font-size:1.3rem;">마이페이지</div>
        </div>
        
        <div class="premium-card text-center">
            <div class="qr-integration-box">
                <div class="qr-top-logo">
                    <img src="https://gnpay.my/log2.png" style="width: 100%;">
                </div>
                <div class="qr-frame">
                    <img id="my-qr-img" src="" style="width: 155px; border-radius: 15px;">
                </div>
            </div>

            <div class="mt-2">
                <div class="user-points-display" id="my-u-points" style="font-size: 2.5rem; font-weight: 900; color: var(--primary);">0</div>
                <div class="small fw-bold opacity-75" style="letter-spacing: 1px;">사용가능 포인트</div>
            </div>
            <div class="mt-4 pt-3 border-top border-secondary small opacity-50">
                푸른 김녕을 만드는 당신은 '김녕의 수호자'입니다.
            </div>
        </div>

        <div class="px-4 mt-4" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="menu-item" onclick="openEditInfo()"><i class="bi bi-person-vcard-fill"></i><div class="menu-title">내 정보 수정</div></div>
            <div class="menu-item" onclick="loadActivityHistory()"><i class="bi bi-journal-check"></i><div class="menu-title">활동 내역</div></div>
        </div>
        <div class="px-4 mt-4 text-center"><button class="btn btn-link text-danger text-decoration-none small" onclick="logout()">로그아웃</button></div>
    </div>

    <div id="page-login" class="page">
        <div class="top-nav">
            <div><img src="https://gnpay.my/log.png" style="width: 85px; margin-bottom: 8px;"><div style="color:var(--primary); font-weight:900; font-size:1.4rem; letter-spacing:-0.5px; margin-left: 10px;">김녕페이 2.0</div></div>
            <div class="fs-2 text-secondary" style="cursor:pointer; padding: 10px;" onclick="showPage('page-main')"><i class="bi bi-x"></i></div>
        </div>
        <div class="mt-4" style="padding-left: 35px; padding-right: 25px;">
            <h1 class="fw-bolder mb-5">반가워요!<br><strong>로그인 해주세요</strong></h1>
            <input type="email" id="login-email" class="form-control custom-input" placeholder="이메일">
            <input type="password" id="login-pw" class="form-control custom-input" placeholder="비밀번호">
            <button class="btn-scan w-100" onclick="submitLogin()">로그인하기</button>
            <div class="text-center mt-4"><span class="text-muted small">계정이 없으신가요?</span><span class="fw-bold ms-2" style="color:var(--primary); cursor:pointer;" onclick="showPage('page-signup')">회원가입</span></div>
        </div>
    </div>

    <div id="page-signup" class="page">
        <div class="top-nav">
            <div><img src="https://gnpay.my/log.png" style="width: 85px; margin-bottom: 8px;"><div style="color:var(--primary); font-weight:900; font-size:1.4rem; letter-spacing:-0.5px; margin-left: 10px;">김녕페이 2.0</div></div>
            <div class="fs-2 text-secondary" style="cursor:pointer; padding: 10px;" onclick="showPage('page-main')"><i class="bi bi-x"></i></div>
        </div>
        <div class="mt-4" style="padding-left: 35px; padding-right: 25px;">
            <h1 class="fw-bolder mb-4">새로운 시작!<br><strong>정보를 입력하세요</strong></h1>
            <input type="text" id="reg-name" class="form-control custom-input" placeholder="이름">
            <input type="email" id="reg-email" class="form-control custom-input" placeholder="이메일">
            <input type="password" id="reg-pw" class="form-control custom-input" placeholder="비밀번호">
            <input type="tel" id="reg-phone" class="form-control custom-input" placeholder="전화번호">
            <button class="btn-scan w-100 mt-2" onclick="submitSignup()">가입하기</button>
        </div>
    </div>

    <div id="page-edit-info" class="page">
        <div class="top-nav">
            <div class="fw-bold text-secondary" style="cursor:pointer; padding:10px;" onclick="showPage('page-mypage')"><i class="bi bi-chevron-left"></i> 취소</div>
            <div class="fw-bold">정보 수정</div>
        </div>
        <div class="px-4 mt-3">
            <div class="form-label">이름 (수정불가)</div>
            <input type="text" id="edit-name" class="form-control custom-input" disabled>
            <div class="form-label">이메일 (수정불가)</div>
            <input type="email" id="edit-email" class="form-control custom-input" disabled>
            <div class="form-label">새 비밀번호</div>
            <input type="password" id="edit-pw" class="form-control custom-input" placeholder="변경할 경우에만 입력">
            <div class="form-label">전화번호</div>
            <input type="tel" id="edit-phone" class="form-control custom-input">
            <button class="btn-scan w-100 mt-4" onclick="submitEditInfo()">수정 완료</button>
        </div>
    </div>

    <div id="page-history" class="page">
        <div class="top-nav">
            <div class="fw-bold text-secondary" style="cursor:pointer; padding:10px;" onclick="showPage('page-mypage')"><i class="bi bi-chevron-left"></i> 뒤로</div>
            <div class="fw-bold">신청 내역</div>
        </div>
        <div class="px-4 mt-2" id="history-list">
            <div class="text-center text-muted mt-5 small">불러오는 중...</div>
        </div>
    </div>

    <div id="page-activities" class="page">
        <div class="top-nav">
            <div class="fw-bold text-secondary" style="cursor:pointer; padding:10px;" onclick="showPage('page-main')"><i class="bi bi-chevron-left"></i> 홈으로</div>
            <div style="color:var(--primary); font-weight:900; font-size:1.3rem;">진행중 활동</div>
        </div>
        <div class="px-3 mt-3">
            <div class="dashboard-card" onclick="openSubmit('김녕 성세기해변 플로깅', 2000, '김녕의 푸른 바다를 위해 플로깅 활동을 인증해주세요.')">
                <div>
                    <div class="fw-bold" style="font-size:1.1rem;">김녕 성세기해변 플로깅</div>
                    <div class="text-success small fw-bold">+2,000 포인트</div>
                </div>
                <i class="bi bi-chevron-right fs-4"></i>
            </div>
        </div>
    </div>

    <div id="page-submit-act" class="page">
        <div class="top-nav">
            <div class="fw-bold text-secondary" style="cursor:pointer; padding:10px;" onclick="showPage('page-main')"><i class="bi bi-x-lg"></i></div>
            <div id="act-title-display" class="fw-bold">인증하기</div>
        </div>
        <div class="px-4 mt-3">
            <div id="act-desc-display" class="small text-muted mb-4 p-3 bg-light rounded-3"></div>
            <div class="small fw-bold text-muted mb-2">활동 내용</div>
            <textarea id="act-content" class="form-control custom-input" rows="4" placeholder="내용을 입력하세요."></textarea>
            <div class="small fw-bold text-muted mb-2">사진 첨부 (최대 3장)</div>
            <input type="file" id="act-files" class="form-control custom-input" accept="image/*" multiple onchange="previewImages()">
            <div id="image-preview" class="d-flex gap-2 mb-4 overflow-auto pb-2"></div>
            <button class="btn-scan w-100" onclick="submitActivity()">신청하기</button>
        </div>
    </div>

    <div id="page-guide" class="page">
        <div class="top-nav">
            <div class="fw-bold text-secondary" style="cursor:pointer; padding:10px;" onclick="showPage('page-main')"><i class="bi bi-x-lg"></i></div>
            <div class="fw-bold">앱 사용 안내</div>
        </div>
        <div class="px-4 mt-3">
            <div class="custom-input p-4">
                <h6 class="fw-bold" style="color:var(--primary);">1. 포인트 적립</h6>
                <p class="small text-muted mb-4">현장 QR 스캔으로 즉시 적립하세요.</p>
                <h6 class="fw-bold" style="color:var(--primary);">2. 활동 인증</h6>
                <p class="small text-muted">활동 미션을 수행하고 사진을 찍어 포인트 신청을 해주세요.</p>
            </div>
        </div>
    </div>

    <div id="scanner-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:20000;">
        <div id="reader" style="width:100%; height:80vh;"></div>
        <button class="btn btn-light" style="position:absolute; bottom:50px; left:50%; transform:translateX(-50%);" onclick="closeScanner()">닫기</button>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbz8m3LTwxNeVFQltpArarGbQq4UQO7-_t3Z1NuQFJEYe6X5jJgGUrsdyCCiFUuBtl4L/exec";
        
        let userData = JSON.parse(localStorage.getItem('gnpay_user')) || { isLoggedIn: false, points: 0 };
        let selectedImages = [];
        let currentAct = { title: "", amount: 0 };
        const loading = document.getElementById('loading-overlay');
        let html5QrCode;

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0, 0);
        }

        function updateUI() {
            const authArea = document.getElementById('auth-area');
            const welcome = document.getElementById('welcome-message');
            document.querySelectorAll('.user-points-display').forEach(el => {
                el.innerText = Number(userData.points || 0).toLocaleString();
            });

            if (userData.isLoggedIn) {
                authArea.innerHTML = `<span class="auth-link" style="color:var(--primary); font-weight:800;" onclick="goToMyPage()">${userData.name}님</span><span style="color:#eee; font-size:0.7rem;">|</span><span class="auth-link" onclick="logout()">로그아웃</span>`;
                welcome.innerHTML = `${userData.name}님, 오늘도<br><strong>푸른 김녕을 지켜요!</strong>`;
                
                if (!window.pointSyncInterval) {
                    window.pointSyncInterval = setInterval(syncPointsRealtime, 5000);
                }
            } else {
                authArea.innerHTML = `<span class="auth-link" onclick="showPage('page-signup')">회원가입</span><span style="color:#eee; font-size:0.7rem;">|</span><span class="auth-link text-dark" onclick="showPage('page-login')">로그인</span>`;
                welcome.innerHTML = `함께 만드는<br><strong>푸른 김녕 Wave</strong>`;
                
                if (window.pointSyncInterval) {
                    clearInterval(window.pointSyncInterval);
                    window.pointSyncInterval = null;
                }
            }
        }

        async function syncPointsRealtime() {
            if (!userData.isLoggedIn) return;
            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ type: 'login', email: userData.email, password: userData.password })
                }).then(r => r.json());

                if (res.result === 'success') {
                    userData.points = res.user.points;
                    localStorage.setItem('gnpay_user', JSON.stringify(userData));
                    document.querySelectorAll('.user-points-display').forEach(el => {
                        el.innerText = Number(res.user.points).toLocaleString();
                    });
                }
            } catch (e) { console.log("sync..."); }
        }

        function goToMyPage() {
            document.querySelectorAll('.user-points-display').forEach(el => {
                el.innerText = Number(userData.points || 0).toLocaleString();
            });
            document.getElementById('my-qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${userData.uid}`;
            showPage('page-mypage');
        }

        async function submitLogin() {
            const email = document.getElementById('login-email').value;
            const pw = document.getElementById('login-pw').value;
            if(!email || !pw) return alert("입력해주세요.");
            loading.style.display='flex';
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'login', email, password: pw }) }).then(r => r.json());
                if (res.result === 'success') {
                    userData = { isLoggedIn: true, ...res.user, password: pw };
                    localStorage.setItem('gnpay_user', JSON.stringify(userData));
                    updateUI();
                    showPage('page-main');
                } else { alert(res.message); }
            } catch (e) { alert("로그인 오류"); }
            loading.style.display='none';
        }

        async function submitSignup() {
            const data = { type: 'signup', name: document.getElementById('reg-name').value, email: document.getElementById('reg-email').value, password: document.getElementById('reg-pw').value, phone: document.getElementById('reg-phone').value };
            loading.style.display='flex';
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(data) }).then(r => r.json());
                if (res.result === 'success') { alert("가입 성공!"); showPage('page-login'); } else { alert(res.message); }
            } catch (e) { alert("회원가입 오류"); }
            loading.style.display='none';
        }

        function openSubmit(title, amount, desc) {
            if (!userData.isLoggedIn) return showPage('page-login');
            currentAct = { title, amount };
            document.getElementById('act-title-display').innerText = title;
            document.getElementById('act-desc-display').innerHTML = desc || "활동 내용을 인증하세요.";
            showPage('page-submit-act');
        }

        function previewImages() {
            const files = document.getElementById('act-files').files;
            const preview = document.getElementById('image-preview');
            preview.innerHTML = '';
            selectedImages = [];
            Array.from(files).slice(0, 3).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImages.push(e.target.result);
                    preview.innerHTML += `<img src="${e.target.result}" style="width:70px;height:70px;border-radius:10px;object-fit:cover;">`;
                };
                reader.readAsDataURL(file);
            });
        }

        async function submitActivity() {
            const content = document.getElementById('act-content').value;
            if(!content || selectedImages.length === 0) return alert("활동 내용과 사진을 등록해주세요.");
            loading.style.display='flex';
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'submitActivity', email: userData.email, title: currentAct.title, content: content, images: selectedImages, pointAmount: currentAct.amount }) }).then(r => r.json());
                if(res.result === 'success') { alert("신청이 완료되었습니다!"); showPage('page-main'); }
                else { alert("오류: " + res.message); }
            } catch(e) { alert("서버 통신 오류"); }
            loading.style.display='none';
        }

        async function loadActivityHistory() {
            showPage('page-history');
            const list = document.getElementById('history-list');
            list.innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-info"></div></div>';
            
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'getActivityHistory', email: userData.email }) }).then(r => r.json());
                if(res.result === 'success') {
                    if(res.history.length === 0) {
                        list.innerHTML = '<div class="text-center text-muted mt-5 small">신청 내역이 없습니다.</div>';
                    } else {
                        list.innerHTML = res.history.map((item, idx) => {
                            let badgeClass = item.status === '승인' ? 'badge-approved' : (item.status === '반려' ? 'badge-rejected' : 'badge-pending');
                            let imagesHtml = '';
                            if(item.img1) imagesHtml += `<img src="${item.img1}" class="history-img">`;
                            if(item.img2) imagesHtml += `<img src="${item.img2}" class="history-img">`;
                            if(item.img3) imagesHtml += `<img src="${item.img3}" class="history-img">`;

                            return `
                                <div class="bg-white p-3 mb-3 rounded-4 shadow-sm border" onclick="this.querySelector('.detail-view').classList.toggle('d-none')">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="badge-status ${badgeClass}">${item.status}</span>
                                        <span class="small text-muted">${item.date}</span>
                                    </div>
                                    <div class="fw-bold">${item.title}</div>
                                    <div class="small text-muted mt-1">+${item.points.toLocaleString()}P</div>
                                    
                                    <div class="detail-view d-none">
                                        <div class="history-content">${item.content}</div>
                                        <div class="d-flex flex-column gap-2">
                                            ${imagesHtml}
                                        </div>
                                    </div>
                                </div>`;
                        }).join('');
                    }
                }
            } catch(e) { list.innerHTML = '<div class="text-center text-danger">데이터 로드 실패</div>'; }
        }

        function openEditInfo() {
            document.getElementById('edit-name').value = userData.name;
            document.getElementById('edit-email').value = userData.email;
            document.getElementById('edit-phone').value = userData.phone;
            showPage('page-edit-info');
        }

        async function submitEditInfo() {
            const newPw = document.getElementById('edit-pw').value;
            const newPhone = document.getElementById('edit-phone').value;
            if(!newPhone) return alert("전화번호를 입력해주세요.");
            loading.style.display = 'flex';
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'updateUserInfo', email: userData.email, newPhone: newPhone, newPw: newPw }) }).then(r => r.json());
                if(res.result === 'success') {
                    alert("정보가 수정되었습니다.");
                    userData.phone = newPhone;
                    if(newPw) userData.password = newPw;
                    localStorage.setItem('gnpay_user', JSON.stringify(userData));
                    showPage('page-mypage');
                } else { alert("수정 실패"); }
            } catch(e) { alert("오류 발생"); }
            loading.style.display = 'none';
        }

        async function handleScan() {
            if (!userData.isLoggedIn) return showPage('page-login');
            document.getElementById('scanner-modal').style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (text) => {
                closeScanner();
                processAddPoints(100, "현장 QR 인증");
            });
        }
        function closeScanner() { if(html5QrCode) html5QrCode.stop(); document.getElementById('scanner-modal').style.display='none'; }
        
        async function processAddPoints(amount, action) {
            loading.style.display = 'flex';
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'addPoints', email: userData.email, amount: amount, action: action }) }).then(r => r.json());
                if (res.result === 'success') {
                    alert(amount + "포인트가 적립되었습니다!");
                    userData.points = res.newPoints;
                    localStorage.setItem('gnpay_user', JSON.stringify(userData));
                    updateUI();
                }
            } catch (e) { alert("적립 오류"); }
            loading.style.display = 'none';
        }

        function logout() { if(confirm('로그아웃 하시겠습니까?')) { localStorage.removeItem('gnpay_user'); location.reload(); } }

        document.getElementById('qr-trigger').onclick = (e) => {
            if (!userData.isLoggedIn) { showPage('page-login'); return; }
            document.getElementById('focus-points').innerText = Number(userData.points).toLocaleString();
            document.getElementById('qr-img-large').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${userData.uid}`;
            document.getElementById('qr-focus-layer').style.display = 'flex';
        };

        window.onload = updateUI;
    </script>
</body>
</html>
