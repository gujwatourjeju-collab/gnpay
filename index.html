<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>김녕페이</title>
    <style>
        body, html { margin:0; padding:0; height:100%; overflow:hidden; background:#f7fbfc; }
        iframe { border:none; width:100%; height:100%; display:block; position:absolute; top:0; left:0; }
    </style>
    <script>
        /** 주소창 방어 **/
        if (window.location.hostname.includes('googleusercontent.com')) {
            window.location.replace('https://gnpay.my');
        }

        const baseUrl = "https://script.google.com/macros/s/AKfycbytgcHHzaZTkp6e1XWBXBVNVFRE8bzgE2i6EI9N3k3Vv0FAyCmv9sfDa1_o212bd94U/exec";
        let currentUser = null;

        // 메시지 리스너 (iframe 생성 전에 먼저 등록)
        window.addEventListener('message', function(e) {
            if (e.data.type === 'GET_SESSION') {
                // 저장된 데이터 있으면 바로 전달
                if (currentUser) {
                    e.source.postMessage({ type: 'SEND_SESSION', data: currentUser }, '*');
                } else {
                    const saved = localStorage.getItem('k_user');
                    if (saved) {
                        try {
                            currentUser = JSON.parse(saved);
                            e.source.postMessage({ type: 'SEND_SESSION', data: currentUser }, '*');
                        } catch(err) {}
                    }
                }
            }
            else if (e.data.type === 'SAVE_USER' && e.data.data) {
                currentUser = e.data.data;
                localStorage.setItem('k_user', JSON.stringify(e.data.data));
            }
            else if (e.data.type === 'LOGOUT') {
                localStorage.removeItem('k_user');
                currentUser = null;
                window.location.replace('https://gnpay.my');
            }
        });

        // iframe 생성 (document.write 대신)
        function createIframe() {
            let src = baseUrl;
            const saved = localStorage.getItem('k_user');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data && data.email) {
                        src += (src.includes('?') ? '&' : '?') + "u=" + encodeURIComponent(data.email) + "&v=" + Date.now();
                        currentUser = data;
                    }
                } catch(e) {}
            }

            const iframe = document.createElement('iframe');
            iframe.id = "appFrame";
            iframe.src = src;
            iframe.allow = "camera; microphone; storage-access";
            iframe.sandbox = "allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation";
            document.body.appendChild(iframe);
        }

        window.addEventListener('load', createIframe);
    </script>
</head>
<body>
</body>
</html>
