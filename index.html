
<!DOCTYPE html>
<html lang="ko">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#e6f7f6"> <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>김녕페이 2.0</title>
    <link rel="icon" href="https://gnpay.my/log2.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
   <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="apple-touch-icon" href="https://gnpay.my/log2.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> <meta name="theme-color" content="#e6f7f6"> 
<link rel="shortcut icon" href="https://gnpay.my/log2.png">
  <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
    :root { --primary: #01b2ad; --primary-grad: linear-gradient(135deg, #01b2ad 0%, #00d2ff 100%); --bg-grad: linear-gradient(180deg, #e6f7f6 0%, #f8fcfc 40%, #ffffff 100%); }
    
    body { 
    font-family: 'Pretendard', sans-serif; 
    /* 1. 배경색을 연민트색으로 고정해서 노치 영역까지 색을 입힙니다 */
    background-color: #e6f7f6; 
    background-image: var(--bg-grad); 
    margin: 0; 
    /* 2. 노치 밑으로 로고가 내려오도록 기본 여백 넉넉히 부여 */
    padding-top: env(safe-area-inset-top, 45px); 
    padding-bottom: 120px;
    min-height: 100vh; 
    color: #1a1a1a; 
    overflow-x: hidden; 
    -webkit-overflow-scrolling: touch; /* 아이폰에서 쫀득한 탄력 스크롤 활성화 */
}
    
    .top-nav { 
    display: flex; 
    justify-content: space-between; 
    align-items: flex-start; 
    padding: 20px 20px 5px 26px; 
    /* 3. sticky 삭제! 이제 글자들과 함께 자연스럽게 스크롤 됩니다 */
    position: relative; 
    z-index: 10;
}
    .auth-links { display: flex; gap: 5px; align-items: center; }
    .auth-link { font-size: 0.8rem; font-weight: 700; color: #888; text-decoration: none; cursor: pointer; padding: 5px; line-height: 1; }
    
    /* 메인 대시보드 숨쉬기 */
    .dashboard-card { 
        background: white; margin: 0 20px 15px; padding: 20px; border-radius: 24px; 
        display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        position: relative; animation: breathe 2s infinite ease-in-out; transition: transform 0.2s ease;
        border: 1px solid rgba(1, 178, 173, 0.1);
    }
    
    @keyframes breathe {
        0% { transform: scale(1); box-shadow: 0 10px 25px rgba(1, 178, 173, 0.15); }
        50% { transform: scale(1.04); box-shadow: 0 0 35px rgba(1, 178, 173, 0.5), 0 10px 40px rgba(0, 210, 255, 0.3); }
        100% { transform: scale(1); box-shadow: 0 10px 25px rgba(1, 178, 173, 0.15); }
    }

    .amount-text { font-size: 1.8rem; font-weight: 900; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    /* [수정] 마이페이지 프리미엄 카드 및 일체형 QR 디자인 */
  .premium-card {
    /* padding 상단을 50px -> 30px로 줄여 공간 확보 */
    padding: 30px 20px 25px !important; 
    margin: 10px 20px !important; 
}

    /* 로고와 QR을 하나로 묶어 숨쉬게 하는 컨테이너 */
.qr-integration-box {
    position: relative; 
    display: inline-block; 
    margin-top: 15px; /* 로고가 걸칠 공간 확보 */
    margin-bottom: 15px; /* 아래쪽 간격 축소 */
}

   .qr-frame {
    padding: 10px !important; /* 내부 여백 줄임 */
    border-radius: 20px !important;
}

    /* 로고 상단 중앙 침범 배치 */
.qr-top-logo {
    position: absolute; 
    /* top을 -20px 정도로 조정하면 프레임 선 중간에 딱 걸칩니다 */
    top: -20px !important; 
    left: 50%; 
    transform: translateX(-50%);
    width: 45px !important; /* 크기도 살짝 컴팩트하게 조절 */
    height: 45px !important;
    z-index: 10;
}
.user-points-display#my-u-points {
    font-size: 2.5rem !important; /* 너무 크면 한 화면에 안 들어오니 살짝 축소 */
}

    @keyframes qr-breathe {
        0% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(1, 178, 173, 0.3)); }
        50% { transform: scale(1.05); filter: drop-shadow(0 0 25px rgba(1, 178, 173, 0.7)); }
        100% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(1, 178, 173, 0.3)); }
    }

    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 20px; margin-bottom: 15px; }
    .menu-item { background: white; padding: 15px 10px; text-align: center; border-radius: 20px; border: 1px solid #eee; cursor: pointer; }
    .menu-item i { font-size: 1.5rem; margin-bottom: 3px; display: inline-block; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .menu-item .menu-title { font-size: 0.85rem; font-weight: 800; color: #333; }

  
    .history-img { width: 100%; max-height: 180px; object-fit: cover; border-radius: 12px; margin-top: 8px; border: 1px solid #eee; display: block; }
    .history-content { font-size: 0.8rem; color: #555; background: #f8f9fa; padding: 10px; border-radius: 10px; margin-top: 8px; }
.page {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw; /* % 대신 vw 사용 */
    height: 100vh; /* % 대신 vh 사용 */
    background-color: white !important;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    display: none;
    opacity: 0;
    /* 아이폰 흔들림 방지 3대장 */
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    -webkit-transform-style: preserve-3d;
    transform-style: preserve-3d;
    will-change: transform, opacity;
    z-index: 10;
}

.page.active {
    display: block;
    opacity: 1;
    z-index: 20; /* 활성 페이지만 위로 뙇! */
}
.page-next {
    transform: scale(0.9) translateX(100%);
    opacity: 0;
}
.from-left { transform: translateX(-100%); }
.from-right { transform: translateX(100%); }
/* 탭바가 가리는 현상 방지용 바닥 여백 */
#page-main, #page-mypage, #page-history, #page-activities, #page-guide, #page-partners {
    padding-bottom: 150px !important; 
}
    .active { display: block !important; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .badge-status { padding: 5px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
    .badge-pending { background: #fff3cd; color: #856404; }
    .badge-approved { background: #d4edda; color: #155724; }
    .badge-rejected { background: #f8d7da; color: #721c24; }
    
    .custom-input { border: none; border-radius: 16px; background: white; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 15px; width: 100%; }
.btn-scan {
    background: var(--primary-grad);
    color: white;
    border: none;
    border-radius: 18px;
    padding: 16px;
    font-weight: 800;
    font-size: 1.1rem;
    box-shadow: 0 10px 20px rgba(1, 178, 173, 0.2);
    transition: all 0.3s ease;
    cursor: pointer;
}

.btn-scan:active, .btn-scan-popup:active {
    transform: scale(0.92) !important;
    filter: brightness(1.1);
    transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
    .form-label { font-size: 0.8rem; font-weight: 700; color: #666; margin-left: 5px; margin-bottom: 5px; }
.activity-badge {
    position: absolute;
    top: 15px;      /* 위에서 15px */
    right: 15px;    /* 오른쪽에서 15px */
    background-color: #FF3B30; /* 아이폰 느낌 강렬한 레드 */
    color: white;
    font-size: 0.7rem;
    font-weight: 900;
    min-width: 18px;
    height: 18px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid white; /* 흰색 테두리가 있어야 고급스럽습니다 */
    box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
    z-index: 10;
    padding: 0 4px;
}
/* 팝업 배경 - 아이폰 스타일 유리창 효과 */
.qr-glass-effect {
    background: rgba(255, 255, 255, 0.4) !important; 
    backdrop-filter: blur(15px) saturate(180%) !important; /* 뒷배경 흐림 효과 */
    -webkit-backdrop-filter: blur(15px) saturate(180%) !important;
    transition: all 0.3s ease;
}

/* 팝업 카드 - 아래에서 위로 스르륵 */
.qr-slide-up {
    animation: luxurySlideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

@keyframes qrSlideUp {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
@keyframes luxurySlideUp {
    from { transform: translateY(100px) scale(0.9); opacity: 0; }
    to { transform: translateY(0) scale(1); opacity: 1; }
}
/* 숫자 밑에 은은한 그림자 */
#focus-points {
    text-shadow: 0 10px 20px rgba(1, 178, 173, 0.2);
}
@keyframes aurora {
    from { box-shadow: 0 0 15px rgba(1, 178, 173, 0.1); }
    to { box-shadow: 0 0 40px rgba(1, 178, 173, 0.4); }
}
/* 1. 탭바 본체: 더 얇고, 더 투명하게 (글래스모피즘) */
.floating-tab-bar {
    position: fixed;
    bottom: 25px;
    left: 50%;
    transform: translateX(-50%);
    width: 88%; /* 약간 더 슬림하게 */
    max-width: 400px;
    background: rgba(255, 255, 255, 0.75); /* 투명도 높임 */
    backdrop-filter: blur(20px) saturate(180%); /* 유리 질감 극대화 */
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    height: 60px; /* 높이를 살짝 줄여 미니멀하게 */
    border-radius: 25px;
    display: flex;
    justify-content: space-around;
    align-items: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); /* 그림자는 아주 은은하게 */
    z-index: 9999 !important;
    border: 1px solid rgba(255, 255, 255, 0.4);
    padding: 0 10px;
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* 이 줄을 추가! */
}

/* 2. 아이콘 스타일: 텍스트는 빼고 아이콘만 강조 (미니멀리즘) */
.tab-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center; /* 수직 중앙 */
    color: #b0b0b0; 
    transition: all 0.3s ease;
    cursor: pointer;
    flex: 1;
    height: 100%;
    position: relative; /* 자식 요소들의 기준점 */
    text-align: center;
}

.tab-item i { 
    font-size: 1.3rem; 
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: block;
    width: 100%; /* 부모 너비를 다 쓰게 해서 중앙 정렬 강제 */
}

.tab-item span { 
    font-size: 0.6rem; 
    font-weight: 800;
    margin-top: 2px;
    opacity: 0.7;
    transition: all 0.2s ease;
}

/* 2. 🌟 활성화 시: 글자 증발 + 아이콘 쫀득 벌크업 */
.tab-item.active { 
    color: #01b2ad; 
}

.tab-item.active i { 
    font-size: 1.8rem; 
    color: #01b2ad;
    animation: jellyPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    filter: drop-shadow(0 0 10px rgba(1, 178, 173, 0.4));
    
    /* 🌟 핵심: 글자가 있건 없건 '중앙'에 고정시키는 마법 */
    transform: translateY(8px); 
    margin-top: 0;
}

.tab-item.active span {
    display: none !important;
}

/* 쫀득한 젤리팝 애니메이션 정의 */
@keyframes jellyPop {
    0% { transform: scale(1) translateY(8px); }
    30% { transform: scale(1.4) translateY(8px); }
    50% { transform: scale(0.9) translateY(8px); }
    100% { transform: scale(1) translateY(8px); }
}

/* 3. 중앙 스캔 버튼도 누를 때 쫀득하게 반응 */
.tab-scan-btn:active {
    transform: scale(0.8) rotate(-8deg); /* 꾹 눌리는 느낌 */
    filter: brightness(1.2);
}

/* 3. 중앙 스캔 버튼: '김녕 민트' 정체성 폭발 */
.tab-scan-btn {
    width: 50px;
    height: 50px;
    background: var(--primary-grad); /* 사장님이 쓰시는 그 그라데이션 */
    border-radius: 18px; /* 로고와 통일감 있는 둥근 사각 */
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 1.5rem;
    margin-top: -30px; /* 살짝만 솟아오르게 */
    box-shadow: 0 8px 20px rgba(1, 178, 173, 0.4);
    border: 4px solid #ffffff; /* 흰색 테두리로 분리감 */
    transition: all 0.3s ease;
}

.tab-scan-btn:active {
    transform: scale(0.9) rotate(5deg);
}
@keyframes login-glow {
    0% { transform: scale(1); box-shadow: 0 10px 25px rgba(1, 178, 173, 0.1); border: 1px solid rgba(1, 178, 173, 0.1); }
    50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(1, 178, 173, 0.3); border: 1px solid rgba(1, 178, 173, 0.5); }
    100% { transform: scale(1); box-shadow: 0 10px 25px rgba(1, 178, 173, 0.1); border: 1px solid rgba(1, 178, 173, 0.1); }
}
.active-tab {
    background: var(--primary);
    color: white;
    box-shadow: 0 4px 12px rgba(1, 178, 173, 0.3);
}
.inactive-tab {
    background: #f0f5f5;
    color: #888;
}
.bottom-nav {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* 슥 내려가는 효과 */
    /* 기존 스타일들... */
}
/* 1. 모든 버튼 및 클릭 요소에 쫀득함 부여 */
button, .btn, .menu-item, .dashboard-card, .tab-item, .auth-link {
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.2s ease !important;
}

/* 2. 누르는 순간(active) 반응 정의 */
button:active, .btn:active, .menu-item:active, .dashboard-card:active, .tab-item:active, .auth-link:active {
    transform: scale(0.94) !important; /* 6% 정도 슥 눌리는 맛 */
    filter: brightness(1.1) !important; /* 살짝 반짝하는 효과 */
}

/* 3. 취소 버튼 같은 회색 버튼 전용 (조금 더 깊게 눌리는 느낌) */
button[style*="background: #f8f9fa"]:active {
    transform: scale(0.92) !important;
    background-color: #e9ecef !important;
}
/* 모든 페이지 기본 상태: 살짝 아래에 있고 투명함 */
.page {
    display: none;
    opacity: 0;
    transform: translateY(15px); /* 살짝 아래에서 대기 */
    transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* 활성화된 페이지: 제자리로 오면서 선명해짐 */
.page.active {
    display: block !important;
    opacity: 1;
    transform: translateY(0);
    animation: pageIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes pageIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
/* 안내 페이지 카드 슬라이더 스타일 */
/* 컨테이너: 배지가 튀어나올 공간을 위해 padding-top을 충분히(40px) 줍니다 */
/* [교체] 수직형 가이드 엔진 */
.guide-slider-container {
    width: 100%;
    height: 450px; /* 고정 높이 부여 */
    overflow-y: auto; /* 세로 스크롤로 변경 */
    scroll-snap-type: y mandatory; /* 세로 방향 자석 효과 */
    -webkit-overflow-scrolling: touch;
    padding: 20px 0;
    scrollbar-width: none;
    display: block; /* 플렉스 해제 */
}
.guide-slider-container::-webkit-scrollbar { display: none; }

.guide-slider {
    display: flex;
    flex-direction: column; /* 세로 정렬 */
    align-items: center;
    gap: 30px; /* 카드 간격 */
    padding: 0 20px 100px; /* 아래쪽 여유 공간 */
}

/* 살아있는 수직 카드 */
.guide-card {
    flex: 0 0 350px; /* 카드의 세로 높이 고정 */
    width: 90%; /* 가로 너비 */
    scroll-snap-align: center;
    background: white;
    border-radius: 40px;
    padding: 40px 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    border: 1px solid rgba(1, 178, 173, 0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    transform: scale(0.9);
    opacity: 0.5;
}

/* 중앙(포커스)에 왔을 때 효과 */
.guide-card.active-focus {
    transform: scale(1.02);
    opacity: 1;
    box-shadow: 0 20px 40px rgba(1, 178, 173, 0.15);
    border: 1px solid rgba(1, 178, 173, 0.3);
}

.guide-step-badge {
    position: absolute;
    top: -15px;
    background: #1a1a1a;
    color: #fff;
    padding: 5px 20px;
    border-radius: 50px;
    font-size: 0.7rem;
    font-weight: 900;
}
.nav-close-btn {
    cursor: pointer;
    padding: 10px;
    color: #adb5bd;
    transition: all 0.2s;
}
.nav-close-btn:active {
    transform: scale(0.9);
    opacity: 0.6;
}
/* 트렌디한 페이지 전환 액션 */
.page {
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
}

/* 들어오는 페이지 효과 */
.page-enter-right { transform: translateX(100%); opacity: 0; }
.page-enter-left { transform: translateX(-100%); opacity: 0; }
.page-active { transform: translateX(0); opacity: 1; }

/* 핀테크 스타일 메뉴 아이템 */
/* 1. 그리드 설정: 1줄에 4개(1fr 1fr 1fr 1fr) */
    .menu-grid-iphone {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        padding: 10px 15px;
        margin-top: 9px;
        background: transparent; /* 배경 삭제 */
    }

    /* 2. 아이템 설정: 프레임 없이 투명하게 */
.menu-item-iphone {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    position: relative;
    /* [핵심] 부드러운 복귀를 위한 트랜지션 */
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.menu-item-iphone:active .icon-circle {
    /* 기존에 하단바에 쓰던 jellyPop 엔진을 여기서 호출합니다 */
    animation: jellyPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
 @keyframes jellyPopMain {
    0% { transform: scale(1); }
    30% { transform: scale(1.2); } /* 살짝 벌크업 */
    50% { transform: scale(0.9); } /* 훅 줄어들었다가 */
    100% { transform: scale(1); } /* 복귀 */
}
.menu-item-iphone:active .icon-circle {
    animation: jellyPopMain 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* 3. 아이콘 박스: 배경 없이 아이콘만 강조하거나 아주 연한 원형 */
.icon-circle {
    position: relative;
    width: 66px;       /* 기존 58px -> 66px로 확대 */
    height: 66px;      /* 기존 58px -> 66px로 확대 */
    border-radius: 20px; /* 덩치가 커졌으니 둥글기도 아이폰 비율에 맞게 20px로 조정 */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.2rem;   /* 내부 그림(이모티콘)도 1.8rem -> 2.2rem으로 시원하게 확대! */
    background: #ffffff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    overflow: visible !important;
    margin-bottom: 8px;  /* 아이콘이 커졌으니 글자와의 간격은 살짝 좁혀서 안정감 부여 */
}

    /* 4. 앱 이름 스타일 */
.menu-title-iphone {
    font-size: 0.78rem;  /* 기존 0.72rem -> 0.78rem으로 가독성 업! */
    font-weight: 700;
    color: #333;
    letter-spacing: -0.5px;
    text-align: center;
    white-space: nowrap;
    line-height: 1.4; 
}
    /* 빨간 배지: 아이콘 오른쪽 상단에 딱! */
.badge-iphone {
    position: absolute;
    /* [수정 포인트] 
       마이너스 값을 주면 아이콘 박스 '바깥쪽'으로 밀려납니다. 
       -5px 정도가 아이폰 앱 배지 위치와 가장 흡사합니다.
    */
    top: -5px; 
    right: -5px; 
    
    background: #FF3B30;
    color: white;
    font-size: 0.7rem;
    font-weight: 900;
    min-width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid white; /* 배경과 대비되는 테두리 필수 */
    z-index: 10;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    padding: 0 2px;
}
@keyframes harryFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}
.fw-900 { font-weight: 900 !important; }
    #rank-table-list .fw-900 { letter-spacing: -0.8px; }
    #rank-info-layer b { color: var(--primary); font-weight: 900; }
    
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.02); opacity: 0.9; }
        100% { transform: scale(1); opacity: 1; }
    }
/* 1. 컨테이너: 박스 형태를 버리고 배경에 녹아들게 */
.level-container {
    margin: 10px 0;
    padding: 12px 16px; /* 크기를 확 줄임 */
    background: transparent; /* 배경색 제거 (부모 컨테이너에 맞춤) */
}

/* 2. 텍스트 레이아웃: 가독성 중심 */
.level-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.current-level {
    font-size: 0.85rem;
    font-weight: 700;
    color: #333;
}

.points-left {
    font-size: 0.75rem;
    color: #888;
}

.points-left strong {
    color: var(--primary); /* 앱 메인 컬러 사용 */
    font-weight: 800;
}

/* 3. 게이지 바: 슬림하고 세련되게 */
.gauge-background {
    width: 100%;
    height: 8px; /* 얇게 변경 */
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
}

.gauge-fill {
    height: 100%;
    background: var(--primary); /* 단색으로 깔끔하게 */
    border-radius: 10px;
    transition: width 0.6s ease-out;
    /* 3D 뱃지와 통일감을 주기 위해 상단에만 아주 얇은 하이라이트 */
    box-shadow: inset 0 1px 1px rgba(255,255,255,0.4);
}

/* 4. 아래 레이블은 굳이 필요 없다면 제거하거나 아주 작게 */
.level-labels {
    display: none; /* 일단 숨겨서 미니멀하게 유지 */
}
.harry-float-container {
    /* 기존 bottom: 5px에서 더 위로 올립니다 */
    bottom: 20px !important; 
    transition: all 0.3s ease-in-out;
}
/* 캐릭터 산책로 전용 베이스 */
.walk-path {
    position: fixed;
    bottom: 75px; 
    left: 0;
    width: 100%;
    height: 100px; /* 캐릭터가 커졌으니 경로 높이도 확보 */
    z-index: 9998;
    pointer-events: none;
    overflow: hidden;
}

#walking-harry {
    width: 95px; /* 기존 65px -> 약 1.5배인 95px로 확대 */
    height: 95px;
    position: absolute;
    object-fit: contain;
    /* 캐릭터가 커진 만큼 그림자도 살짝 더 깊게 줘야 바닥에 딱 붙어 보입니다 */
    filter: drop-shadow(4px 8px 6px rgba(0,0,0,0.2));
    animation: harryWalk 18s linear infinite; /* 덩치가 커졌으니 속도를 살짝 늦춰야 더 묵직하고 귀엽습니다 */
}

@keyframes harryWalk {
    0% { left: -100px; transform: scaleX(1); } /* 시작 위치도 캐릭터 크기만큼 조절 */
    48% { transform: scaleX(1); }
    50% { left: calc(100% + 20px); transform: scaleX(-1); }
    98% { transform: scaleX(-1); }
    100% { left: -100px; transform: scaleX(1); }
}
</style>
</head>
<body>
<body>

    <div id="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 10000; display: none; justify-content: center; align-items: center; flex-direction: column;">
        <div class="spinner-border text-info" role="status"></div>
        <div class="mt-3 fw-bold" style="color:var(--primary)">처리 중입니다...</div>
    </div>

    <div id="qr-focus-layer" onclick="this.style.display='none'" class="qr-glass-effect" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center;">
        <div class="bg-white p-4 rounded-5 text-center shadow-lg qr-slide-up" style="width:85%; max-width:350px; border: 1px solid rgba(255,255,255,0.3); position: relative;" onclick="event.stopPropagation()">
            <div class="qr-wrapper" style="position: relative; width: 100%; display: flex; justify-content: center; align-items: center; background: #f8fcfc; padding: 22px 10px; border-radius: 30px; box-shadow: 0 0 30px rgba(1, 178, 173, 0.15); animation: aurora 3s infinite alternate; margin-top: 25px;">
                <div style="position: absolute; top: -24px; left: 50%; transform: translateX(-50%); width: 48px; height: 48px; background: #01b2ad; border-radius: 14px; border: 3px solid #ffffff; box-shadow: 0 5px 12px rgba(1, 178, 173, 0.2); display: flex; align-items: center; justify-content: center; z-index: 10; overflow: hidden;">
                    <img src="https://gnpay.my/log2.png" style="width: 100%; height: 100%; object-fit: cover; background: #01b2ad; padding: 6px;">
                </div>
                <img id="qr-img-large" src="" style="width: 100%; max-width: 250px; border-radius: 12px; display: block;">
            </div>
            
            <div class="mt-4">
                <div class="amount-text user-points-display" id="focus-points" style="font-size: 2.7rem; font-weight: 900; color: var(--primary);">0</div>
                <div class="small text-muted fw-bold" style="opacity: 0.6; letter-spacing: 1px;">나의 에코 포인트</div>
            </div>
            <button class="btn mt-4 w-100 rounded-pill fw-bold" style="background: #f1f3f5; color: #666; padding: 12px;" onclick="closeQR()">닫기</button>
        </div>
    </div>

    <div id="page-main" class="page active">
        <div class="top-nav">
            <div onclick="showPage('page-main')" style="cursor: pointer;">
    <img src="https://gnpay.my/log.png" style="width: 85px; margin-bottom: 8px;">
    <div style="color:var(--primary); font-weight:900; font-size:1.4rem; letter-spacing:-0.5px; margin-bottom: 5px; margin-left: 10px;">김녕페이 2.0</div>
</div>
            <div class="auth-links" id="auth-area"></div>
        </div>
      <div class="pb-4" style="padding-left: 35px; padding-right: 25px; position: relative;">
    <h1 class="fw-bolder mt-2" id="welcome-message">
        제주에서 함께 하는<br><strong>탄소중립 실천</strong>
    </h1>

<div class="harry-float-container" style="position: absolute; right: 10px; bottom: 5px; width: 110px; height: 110px; z-index: 10;">
    <div id="harry-motion-box" style="width: 100%; height: 100%; position: relative; animation: harryFloat 3s infinite ease-in-out;">
        <div class="harry-float-container" onclick="openRankInfo()" style="position: absolute; right: 22px; bottom: 5px; width: 110px; height: 110px; z-index: 10; cursor: pointer;"></div>
        <div id="harry-badge" style="
            position: absolute; top: -20px; left: 5px; 
            background: linear-gradient(145deg, #222, #000); 
            color: #ffffff; padding: 5px 12px; border-radius: 20px; 
            font-size: 0.7rem; font-weight: 800; white-space: nowrap; 
            box-shadow: 3px 3px 8px rgba(0,0,0,0.3), inset 1px 1px 2px rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.1); z-index: 11;">
            반가워요! 🌊
        </div>

        <img id="harry-img" src="https://gnpay.my/3dlog.png" 
             style="width: 100%; height: 100%; object-fit: contain;"
             onerror="this.src='https://gnpay.my/harry.png'">
    </div>
</div>
</div>
        <div class="dashboard-card" id="qr-trigger">
            <div><div class="small fw-bold text-muted">MY POINTS</div><div class="amount-text user-points-display" id="main-u-points">0</div></div>
            <div style="background: var(--primary-grad); color:white; width:50px; height:50px; border-radius:18px; display:flex; align-items:center; justify-content:center; font-size:1.5rem;"><i class="bi bi-qr-code"></i></div>
        </div>
       <div class="menu-grid-iphone">
    <div class="menu-item-iphone" onclick="openSubmit('우리 마을 플로깅 (자유)', 2000, '...')">
        <div class="icon-circle" style="color: #01b2ad;">
            <i class="bi bi-tree-fill"></i>
        </div>
        <div class="menu-title-iphone">자유활동</div>
    </div>

    <div class="menu-item-iphone" onclick="showPage('page-partners')">
        <div class="icon-circle" style="color: #ff9800;">
            <i class="bi bi-bag-heart-fill"></i>
        </div>
        <div class="menu-title-iphone">가맹점</div>
    </div>
<div class="menu-item-iphone" onclick="showPage('page-activities')">
    <div class="icon-circle" style="color: #00d2ff;">
        <div id="activity-badge-count" class="badge-iphone" style="display: none;">0</div>
        <i class="bi bi-lightning-charge-fill"></i>
    </div>
    <div class="menu-title-iphone">퀘스트</div>
</div>
<div class="menu-item-iphone" onclick="showPage('page-ranking'); loadRankingData('today');">
    <div class="icon-circle" style="color: #ffc107;"> <i class="bi bi-trophy-fill"></i>
    </div>
    <div class="menu-title-iphone">수호자 랭킹</div>
</div>

    <div class="menu-item-iphone" onclick="showPage('page-guide')">
        <div class="icon-circle" style="color: #673ab7;">
            <i class="bi bi-info-circle-fill"></i>
        </div>
        <div class="menu-title-iphone">이용안내</div>
    </div>
</div>
    </div> 
    
    <div id="page-guide" class="page">
    <div class="top-nav">
        <div onclick="showPage('page-main')" style="cursor: pointer;">
            <img src="https://gnpay.my/log.png" style="width: 85px;">
            <div style="color:var(--primary); font-weight:900; font-size:1.4rem; letter-spacing:-0.5px; margin-left: 10px;">앱 이용 안내</div>
        </div>
        <div class="fs-2 text-secondary" style="cursor:pointer; padding: 10px;" onclick="showPage('page-main')">
            <i class="bi bi-x-lg" style="font-size: 1.5rem; opacity: 0.6;"></i>
        </div>
    </div>

    <div class="pb-2" style="padding-left: 35px; padding-right: 25px;">
        <h1 class="fw-bolder mt-2" style="font-size: 1.8rem; line-height: 1.2; letter-spacing: -1.5px;">김녕페이<br><strong>사용 가이드</strong></h1>
    </div>

    <div class="guide-slider-container" id="guide-slider-scroll">
        <div class="guide-slider">
            <div class="guide-card active-focus">
                <div class="guide-step-badge">STEP 01</div>
                <div class="guide-icon-circle" style="width:75px; height:75px; border-radius:22px; background:#e6f7f6; color:var(--primary); display:flex; align-items:center; justify-content:center; font-size:2rem; margin-bottom:20px;">
                    <i class="bi bi-tree-fill"></i>
                </div>
                <h4 style="font-weight:900; letter-spacing:-1px; margin-bottom:12px;">에코 포인트 적립</h4>
                <div class="step-desc" style="color:#666; font-size:0.95rem; line-height:1.7;">
                    김녕 성세기 해변 정화 후<br>
                    <strong>활동 사진</strong>을 인증하면<br>
                    에코 포인트가 즉시 지급됩니다.
                </div>
            </div>

            <div class="guide-card">
                <div class="guide-step-badge">STEP 02</div>
                <div class="guide-icon-circle" style="width:75px; height:75px; border-radius:22px; background:#fff9e6; color:#d4a017; display:flex; align-items:center; justify-content:center; font-size:2rem; margin-bottom:20px;">
                    <i class="bi bi-bag-heart-fill"></i>
                </div>
                <h4 style="font-weight:900; letter-spacing:-1px; margin-bottom:12px;">마을 가맹점 사용</h4>
                <div class="step-desc" style="color:#666; font-size:0.95rem; line-height:1.7;">
                    적립된 포인트는 김녕 마을의<br>
                    <strong>카페, 식당, 체험처</strong>에서<br>
                    현금처럼 자유롭게 사용하세요.
                </div>
            </div>

            <div class="guide-card">
                <div class="guide-step-badge">STEP 03</div>
                <div class="guide-icon-circle" style="width:75px; height:75px; border-radius:22px; background:#eefbff; color:#0099cc; display:flex; align-items:center; justify-content:center; font-size:2rem; margin-bottom:20px;">
                    <i class="bi bi-qr-code-scan"></i>
                </div>
                <h4 style="font-weight:900; letter-spacing:-1px; margin-bottom:12px;">스마트 체크인</h4>
                <div class="step-desc" style="color:#666; font-size:0.95rem; line-height:1.7;">
                    마이페이지 <strong>나의 QR</strong>로<br>
                    가맹점 입장과 본인 확인을<br>
                    누구보다 빠르게 해결하세요.
                </div>
            </div>
        </div>
    </div>

  <div class="text-center mt-2">
    <div class="badge rounded-pill bg-light text-dark px-3 py-2" style="font-size: 0.75rem; opacity: 0.7; border: 1px solid #eee;">
        <i class="bi bi-arrow-up-down me-1"></i> 위아래로 밀어서 다음 단계 확인
    </div>
</div>
</div>
<div id="page-mypage" class="page"> 
    <div class="top-nav" style="display: flex; justify-content: space-between; align-items: flex-start; padding: 20px 20px 5px 26px;">
        <div onclick="showPage('page-main')" style="cursor: pointer;">
            <img src="https://gnpay.my/log.png" style="width: 85px;">
        </div>
        
        <div class="auth-links" id="mypage-auth-buttons" style="display: none;">
            <span class="auth-link" onclick="openEditInfo()" style="color:var(--primary); font-weight:800; font-size: 0.8rem; padding: 5px; line-height: 1;">정보수정</span>
            <span style="color:#eee; font-size:0.7rem; line-height: 1;">|</span>
            <span class="auth-link" onclick="logout()" style="font-size: 0.8rem; font-weight: 700; color: #888; padding: 5px; line-height: 1;">로그아웃</span>
        </div>
    </div>

    <div id="mypage-guest-content" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60vh; text-align: center; padding: 20px;">
        <div style="background: #f0fafa; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
            <i class="bi bi-person-lock" style="font-size: 2.5rem; color: var(--primary); opacity: 0.5;"></i>
        </div>
        <h5 class="fw-900">로그인이 필요합니다</h5>
        <p style="font-size: 0.85rem; color: #888; line-height: 1.5; margin-bottom: 25px;">
            회원 정보와 포인트 내역을 확인하시려면<br>로그인을 먼저 진행해주세요.
        </p>
        <button class="btn-scan" onclick="showPage('page-login')" style="width: 180px; padding: 12px; font-weight: 800; border-radius: 15px;">로그인 하러가기</button>
    </div>

    <div id="mypage-user-content" style="display: none;">
    <div class="mt-1" style="padding-left: 20px; padding-right: 20px;">
        <div class="premium-card text-center" style="margin: 0; background: white; border: 1px solid rgba(1, 178, 173, 0.15); box-shadow: 0 15px 35px rgba(0,0,0,0.08); border-radius: 35px; padding: 20px 20px 15px;">
            
            <div style="margin-bottom: 10px;">
                <div id="mypage-rank-label" style="color: var(--primary); font-size: 0.8rem; font-weight: 900; letter-spacing: 1px; margin-bottom: 5px; opacity: 1;">
                    &nbsp;
                </div>
                
                <div style="color: #1a1a1a; font-size: 1.5rem; font-weight: 900; letter-spacing: -1px;">
                    <span id="mypage-user-name" style="color:var(--primary)"></span>님, 반가워요!
                </div>
            </div>

          <div class="qr-integration-box" style="margin-top: 15px; margin-bottom: 20px; display: inline-block; position: relative; animation: qr-breathe 2s infinite ease-in-out;">
    
    <div class="qr-top-logo" style="position: absolute; top: -18px; left: 50%; transform: translateX(-50%); border: 3px solid #fff; width: 42px; height: 42px; background: #01b2ad !important; overflow: hidden; display: flex; align-items: center; justify-content: center; border-radius: 12px !important; z-index: 10; box-shadow: 0 5px 12px rgba(0,0,0,0.2);"> 
        <img src="https://gnpay.my/log2.png" style="width: 100%; height: 100%; object-fit: contain;">
    </div>

    <div class="qr-frame" style="background: #f8fcfc; padding: 10px; border-radius: 25px; display: inline-block; border: 1px solid #edf7f6; box-shadow: 0 0 20px rgba(1, 178, 173, 0.2); animation: aurora 3s infinite alternate;">
        <img id="my-qr-img" src="" style="width: 145px; height: 145px; border-radius: 15px; display: block;">
    </div>
</div>

            <div style="background: #f8fcfc; padding: 15px 15px; border-radius: 28px; border: 1px solid rgba(1, 178, 173, 0.1);">
                <div style="color: #888; font-size: 0.7rem; font-weight: 700; letter-spacing: 1px; margin-bottom: 2px;">사용가능 포인트</div>
                <div style="display: flex; align-items: baseline; justify-content: center; gap: 4px;">
                    <div class="user-points-display" id="my-u-points" style="font-size: 2.4rem; font-weight: 900; color: var(--primary); line-height: 1;">0</div>
                    <div style="font-size: 1.1rem; font-weight: 800; color: #333;">P</div>
                </div>
                
                <div class="text-center mt-2">
                    <button onclick="loadActivityHistory()" 
                            style="background: rgba(1, 178, 173, 0.08); border: none; padding: 6px 15px; border-radius: 50px; color: var(--primary); font-size: 0.75rem; font-weight: 800;">
                        내역 보기 <i class="bi bi-chevron-right ms-1"></i>
                    </button>
                </div>

                <div class="level-container" onclick="openRankInfo()" style="cursor: pointer; padding: 10px 5px 0px;">
                    <div class="level-info" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="display: flex; flex-direction: column; align-items: flex-start;">
                            <span style="font-size: 0.6rem; color: #aaa; font-weight: 800; letter-spacing: 0.5px; margin-bottom: 2px;">다음 등급</span>
                            <span id="pop-rank-badge-text" style="font-size: 0.85rem; font-weight: 900; color: #333; letter-spacing: -0.5px;">목표 확인 중</span>
                        </div>
                        <div style="text-align: right; display: flex; flex-direction: column; align-items: flex-end;">
                            <span style="font-size: 0.6rem; color: #aaa; font-weight: 800; letter-spacing: 0.5px; margin-bottom: 2px;">남은 포인트</span>
                            <div style="font-size: 1rem; font-weight: 900; color: var(--primary); line-height: 1;">
                                <span id="pop-next-info">0</span><span style="font-size: 0.7rem; margin-left: 2px;">P</span>
                            </div>
                        </div>
                    </div>
                    <div class="gauge-background" style="width: 100%; height: 8px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden;">
                        <div id="pop-gauge-bar" class="gauge-fill" style="width: 0%; height: 100%; background: var(--primary-grad); border-radius: 10px; transition: width 1.2s cubic-bezier(0.1, 0.9, 0.2, 1);"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div></div>

        
  <div id="page-login" class="page">
    <div class="top-nav">
        <div onclick="showPage('page-main')" style="cursor: pointer;">
            <img src="https://gnpay.my/log.png" style="width: 85px; margin-bottom: 8px;">
            <div style="color:var(--primary); font-weight:900; font-size:1.4rem; letter-spacing:-0.5px; margin-bottom: 5px; margin-left: 10px;">김녕페이 2.0</div>
        </div>
        <div class="fs-2 text-secondary" style="cursor:pointer; padding: 10px;" onclick="showPage('page-main')"><i class="bi bi-x"></i></div>
    </div>

    <div class="mt-2" style="padding-left: 35px; padding-right: 25px;">
        <h1 class="fw-bolder mb-4" style="line-height: 1.2;">반가워요!<br><strong>로그인 해주세요</strong></h1>
        
        <div class="mt-5"> 
<input type="email" id="login-email" class="form-control custom-input" placeholder="이메일" disabled>
<input type="password" id="login-pw" class="form-control custom-input" placeholder="비밀번호" disabled>
            
            <div class="d-flex justify-content-between align-items-center px-1 mb-4" style="margin-top: -5px;">
                <div class="form-check d-flex align-items-center gap-2">
                    <input class="form-check-input" type="checkbox" id="remember-me" style="width: 17px; height: 17px; cursor: pointer;">
                    <label class="form-check-label small text-muted" for="remember-me" style="cursor: pointer; padding-top: 2px;">아이디 기억</label>
                </div>
                <div class="small text-muted" onclick="handleForgotPassword()" style="cursor: pointer;">비밀번호를 잊으셨나요?</div>
            </div>

            <button class="btn-scan w-100" onclick="submitLogin()">로그인하기</button>

            <div class="text-center mt-4">
                <span class="text-muted small">아직 회원이 아니신가요?</span>
                <span class="fw-bold small ms-2" style="color:var(--primary); cursor:pointer;" onclick="showPage('page-signup')">회원가입</span>
            </div>
        </div>
    </div>
</div>
<div id="pw-reset-layer" class="qr-glass-effect" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10001; display: none; flex-direction: column; align-items: center; justify-content: center;">
    <div class="bg-white p-4 rounded-5 shadow-lg qr-slide-up" style="width:85%; max-width:350px; position: relative; border: 1px solid rgba(255,255,255,0.3);">
        
        <div style="position: absolute; top: -20px; left: 20px; width: 55px; height: 55px; 
            background: #01b2ad; /* 김녕페이 메인 로고색 */
            border-radius: 18px; 
            border: 4px solid #fff; 
            box-shadow: 0 8px 15px rgba(1, 178, 173, 0.3); 
            display: flex; align-items: center; justify-content: center; z-index: 10;">
    
    <img src="https://gnpay.my/log2.png" style="width: 80%; height: 80%; object-fit: contain;">
</div>

        <div class="text-center mt-3 mb-4">
            <h5 class="fw-bold" style="color: #333; letter-spacing: -1px;">비밀번호 찾기</h5>
            <p class="small text-muted" style="font-size: 0.75rem;">등록된 이메일과 전화번호를 입력하세요.</p>
        </div>
        
        <div class="px-1">
            <div class="form-label" style="font-size: 0.7rem; color: #01b2ad;">가입 이메일</div>
            <input type="email" id="reset-email" class="form-control custom-input" placeholder="example@email.com" style="margin-bottom: 12px; font-size: 0.9rem;">
            
            <div class="form-label" style="font-size: 0.7rem; color: #01b2ad;">전화번호</div>
            <input type="tel" id="reset-phone" class="form-control custom-input" placeholder="숫자만 입력" style="margin-bottom: 20px; font-size: 0.9rem;">
        </div>
        
        <div class="d-flex gap-2">
            <button class="btn w-50 rounded-pill fw-bold" style="background: #f8f9fa; color: #999; padding: 14px; border: none; font-size: 0.9rem;" onclick="document.getElementById('pw-reset-layer').style.display='none'">취소</button>
            <button class="btn-scan w-50" style="padding: 14px; font-size: 1rem; background: #01b2ad; border: none; color: #fff; border-radius: 50px;" onclick="processPwReset()">확인</button>
        </div>
    </div>
</div>


    <div id="page-signup" class="page">
    <div class="top-nav">
        <div onclick="showPage('page-main')" style="cursor: pointer;">
            <img src="https://gnpay.my/log.png" style="width: 85px; margin-bottom: 8px;">
            <div style="color:var(--primary); font-weight:900; font-size:1.4rem; letter-spacing:-0.5px; margin-bottom: 5px; margin-left: 10px;">김녕페이 2.0</div>
        </div>
        <div class="fs-2 text-secondary" style="cursor:pointer; padding: 10px;" onclick="showPage('page-main')"><i class="bi bi-x"></i></div>
    </div>
    
    <div class="mt-2" style="padding-left: 35px; padding-right: 25px;">
        <h1 class="fw-bolder mb-4" style="line-height: 1.2;">새로운 시작!<br><strong>정보를 입력하세요</strong></h1>
        
        <div class="mt-4">
            <div class="d-flex gap-2 mb-3">
                <div style="position: relative; flex: 2;">
                    <i class="bi bi-person" style="position: absolute; left: 16px; top: 16px; color: #adb5bd;"></i>
                    <input type="text" id="reg-name" class="form-control custom-input" placeholder="이름" style="padding-left: 45px; margin-bottom:0;">
                </div>
                <div style="flex: 1;">
                    <select id="reg-gender" class="form-control custom-input" style="padding-left: 15px; margin-bottom:0; font-weight: 600; color: #666;">
                        <option value="">성별</option>
                        <option value="남">남성</option>
                        <option value="여">여성</option>
                    </select>
                </div>
            </div>

            <div style="position: relative; margin-bottom: 12px;">
                <i class="bi bi-envelope" style="position: absolute; left: 16px; top: 16px; color: #adb5bd;"></i>
                <input type="email" id="reg-email" class="form-control custom-input" placeholder="이메일" style="padding-left: 45px;">
            </div>
            <div style="position: relative; margin-bottom: 5px;">
            <i class="bi bi-lock" style="position: absolute; left: 16px; top: 16px; color: #adb5bd;"></i>
            <input type="password" id="reg-pw" class="form-control custom-input" 
             placeholder="비밀번호 (영문+숫자 혼합)" 
             style="padding-left: 45px;">
            </div>
               <div style="position: relative; margin-bottom: 12px;">
                <i class="bi bi-phone" style="position: absolute; left: 16px; top: 16px; color: #adb5bd;"></i>
                <input type="tel" id="reg-phone" class="form-control custom-input" placeholder="전화번호 (숫자만 연속해서 입력)" style="padding-left: 45px;">
            </div>

            <div style="position: relative; margin-bottom: 20px;">
                <i class="bi bi-geo-alt" style="position: absolute; left: 16px; top: 16px; color: #adb5bd;"></i>
                <select id="reg-region" class="form-control custom-input" style="padding-left: 45px; font-weight: 600; color: #666;">
                    <option value="">거주 지역 선택</option>
                    <option value="제주">제주</option>
                    <option value="서울">서울</option>
                    <option value="경기">경기</option>
                    <option value="인천">인천</option>
                    <option value="강원">강원</option>
                    <option value="대전">대전</option>
                    <option value="전북">전북</option>
                    <option value="전남">전남</option>
                    <option value="광주">광주</option>
                    <option value="충남">충남</option>
                    <option value="충북">충북</option>
                    <option value="경북">경북</option>
                    <option value="경남">경남</option>
                    <option value="부산">부산</option>
                    <option value="대구">대구</option>
                    <option value="기타">기타</option>
                </select>
            </div>

            <div class="p-3 mb-4" style="background: rgba(1, 178, 173, 0.05); border-radius: 18px; border: 1px dashed rgba(1, 178, 173, 0.3);">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <input type="checkbox" id="reg-agree" style="width: 20px; height: 20px; accent-color: var(--primary);">
                        <label for="reg-agree" class="ms-2 small fw-bold text-dark" style="cursor:pointer;">개인정보 수집 및 이용 동의 (필수)</label>
                    </div>
                    <span class="small text-muted" style="text-decoration: underline; cursor:pointer;" onclick="alert('김녕페이 서비스 제공을 위한 최소한의 정보를 수집합니다.')">보기</span>
                </div>
            </div>
            
            <button class="btn-scan w-100 mt-2" onclick="checkAndSignup()">가입하기</button>
        </div>

        <div class="text-center mt-4 pb-5">
            <span class="text-muted small">이미 계정이 있으신가요?</span>
            <span class="fw-bold ms-2" style="color:var(--primary); cursor:pointer;" onclick="showPage('page-login')">로그인</span>
        </div>
    </div>
</div>
<div id="profile-edit-layer" class="qr-glass-effect" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10001; display: none; flex-direction: column; align-items: center; justify-content: center;">
    <div class="bg-white p-4 rounded-5 shadow-lg qr-slide-up" style="width:85%; max-width:350px; position: relative; border: 1px solid rgba(255,255,255,0.3);">
        
        <div style="position: absolute; top: -20px; left: 20px; width: 55px; height: 55px; background: #01b2ad; border-radius: 18px; border: 4px solid #fff; box-shadow: 0 8px 15px rgba(1, 178, 173, 0.3); display: flex; align-items: center; justify-content: center; z-index: 10;">
            <img src="https://gnpay.my/log2.png" style="width: 80%; height: 80%; object-fit: contain;">
        </div>

        <div class="text-center mt-3 mb-4">
            <h5 class="fw-bold" style="color: #333; letter-spacing: -1px;">
                <span id="edit-user-name" style="color: #01b2ad;">사용자</span>님 정보 수정
            </h5>
            <p class="small text-muted" style="font-size: 0.75rem;">변경할 정보를 입력해 주세요.</p>
        </div>
        
        <div class="px-1">
            <div class="form-label" style="font-size: 0.7rem; color: #01b2ad;">거주 지역</div>
            <select id="popup-edit-region" class="form-control custom-input" style="margin-bottom: 12px; font-size: 0.9rem; font-weight: 600;">
                <option value="제주">제주</option><option value="서울">서울</option><option value="경기">경기</option>
                <option value="인천">인천</option><option value="강원">강원</option><option value="대전">대전</option>
                <option value="전북">전북</option><option value="전남">전남</option><option value="광주">광주</option>
                <option value="충남">충남</option><option value="충북">충북</option><option value="경북">경북</option>
                <option value="경남">경남</option><option value="부산">부산</option><option value="대구">대구</option>
                <option value="기타">기타</option>
            </select>

            <div class="form-label" style="font-size: 0.7rem; color: #01b2ad;">전화번호</div>
            <input type="tel" id="popup-edit-phone" class="form-control custom-input" placeholder="숫자만 입력" style="margin-bottom: 12px; font-size: 0.9rem;">
            
            <div class="form-label" style="font-size: 0.7rem; color: #01b2ad;">새 비밀번호 (선택)</div>
            <input type="password" id="popup-edit-pw" class="form-control custom-input" placeholder="변경 시에만 입력" style="margin-bottom: 20px; font-size: 0.9rem;">
        </div>
        
        <div class="d-flex gap-2">
            <button class="btn w-50 rounded-pill fw-bold" style="background: #f8f9fa; color: #999; padding: 14px; border: none; font-size: 0.9rem;" onclick="document.getElementById('profile-edit-layer').style.display='none'">취소</button>
            <button class="btn-scan w-50" style="padding: 14px; font-size: 1rem; background: #01b2ad; border: none; color: #fff; border-radius: 50px;" onclick="submitPopupEdit()">수정완료</button>
        </div>
    </div>
</div>

<div id="rank-info-layer" class="qr-glass-effect" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10001; display: none; flex-direction: column; align-items: center; justify-content: center;" onclick="this.style.display='none'">
    <div class="bg-white p-4 rounded-5 shadow-lg qr-slide-up" style="width:88%; max-width:360px; position: relative; border: 1px solid rgba(255,255,255,0.3);" onclick="event.stopPropagation()">
        
        <div style="position: absolute; top: -20px; left: 20px; width: 55px; height: 55px; background: var(--primary-grad); border-radius: 18px; border: 4px solid #fff; box-shadow: 0 8px 15px rgba(1, 178, 173, 0.3); display: flex; align-items: center; justify-content: center; z-index: 10;">
            <i class="bi bi-stars" style="color: white; font-size: 1.5rem;"></i>
        </div>

        <div class="text-center mt-3 mb-4">
    <h5 class="fw-900" style="color: #1a1a1a; letter-spacing: -1.5px; font-size: 1.4rem; line-height: 1.1;">
        김녕 수호자 <span style="color: var(--primary);">리포트</span>
    </h5>
    <p style="font-size: 0.8rem; font-weight: 600; color: #888; margin-top: 5px; letter-spacing: -0.5px;">
        실천할수록 김녕의 보물이 자라나요!
    </p>
</div>
        
        <div class="p-4 mb-4" style="background: #f0fafa; border-radius: 30px; border: 1px solid #e0f2f1; position: relative; overflow: hidden;">
            <div class="d-flex align-items-center gap-3 mb-3">
                <div style="background: white; padding: 10px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                    <img id="pop-rank-img" src="" style="width: 65px; height: 65px; object-fit: contain;">
                </div>
                <div style="flex: 1;">
                    <div id="pop-rank-badge" style="display:inline-block; padding:3px 10px; border-radius:12px; font-size:0.7rem; color:white; font-weight:800; margin-bottom:5px;"></div>
                    <div class="fw-900" style="font-size: 1.2rem; color:#222;"><span id="pop-user-name"></span>님</div>
                </div>
            </div>

            <div id="gauge-container">
                <div class="d-flex justify-content-between small fw-bold mb-1" style="font-size: 0.65rem; color: #666;">
                    <span>성장 에너지</span>
                    <span id="pop-gauge-percent">0%</span>
                </div>
                <div style="width: 100%; height: 12px; background: #e0e0e0; border-radius: 10px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);">
                    <div id="pop-gauge-bar" style="width: 0%; height: 100%; background: var(--primary-grad); transition: width 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);"></div>
                </div>
                <div id="pop-next-info" class="text-center mt-2 fw-800" style="font-size: 0.75rem; color: var(--primary);"></div>
            </div>
        </div>

        <div id="rank-table-list" style="max-height: 220px; overflow-y: auto; padding-right: 5px;">
            </div>
        
        <button class="btn-scan w-100 mt-3" style="padding: 15px; border-radius: 20px;" onclick="document.getElementById('rank-info-layer').style.display='none'">확인 완료</button>
    </div>
</div>
    <div id="page-history" class="page">
    <div class="top-nav">
        <div onclick="showPage('page-main')" style="cursor: pointer;">
            <img src="https://gnpay.my/log.png" style="width: 85px; margin-bottom: 8px;">
            <div style="color:var(--primary); font-weight:900; font-size:1.4rem; letter-spacing:-0.5px; margin-bottom: 5px; margin-left: 10px;">나의 활동 기록</div>
        </div>
        <div class="fs-2 text-secondary" style="cursor:pointer; padding: 10px;" onclick="showPage('page-main')">
            <i class="bi bi-x-lg" style="font-size: 1.5rem; opacity: 0.6;"></i>
        </div>
    </div>

    <div class="d-flex px-4 mt-2 mb-4" style="gap: 10px;">
        <div id="tab-point" class="flex-fill text-center py-2 active-tab" onclick="switchHistoryTab('point')" style="cursor:pointer; font-weight:800; border-radius:15px; font-size:0.9rem;">포인트 내역</div>
        <div id="tab-activity" class="flex-fill text-center py-2 inactive-tab" onclick="switchHistoryTab('activity')" style="cursor:pointer; font-weight:800; border-radius:15px; font-size:0.9rem;">정화활동 현황</div>
    </div>

    <div style="padding-left: 20px; padding-right: 20px;">
        <div id="history-point-section">
            <div class="small text-muted mb-4" style="padding-left: 15px; opacity: 0.8;">포인트 적립 및 사용 기록입니다.</div>
            <div id="point-history-list">
                <div class="text-center text-muted mt-5 small">포인트 내역을 불러오는 중...</div>
            </div>
        </div>

        <div id="history-activity-section" style="display:none;">
            <div class="small text-muted mb-4" style="padding-left: 15px; opacity: 0.8;">신청하신 환경 정화 활동의 승인 현황입니다.</div>
            <div id="activity-history-list">
                <div class="text-center text-muted mt-5 small">활동 신청 내역이 없습니다.</div>
            </div>
        </div>
    </div>
</div>

    <div id="page-activities" class="page">
    <div class="top-nav">
        <div onclick="showPage('page-main')" style="cursor: pointer;">
            <img src="https://gnpay.my/log.png" style="width: 85px; margin-bottom: 8px;">
            <div style="color:var(--primary); font-weight:900; font-size:1.4rem; letter-spacing:-0.5px; margin-bottom: 5px; margin-left: 10px;">진행중 퀘스트</div>
        </div>
        <div class="fs-2 text-secondary" style="cursor:pointer; padding: 10px;" onclick="showPage('page-main')">
            <i class="bi bi-x-lg" style="font-size: 1.5rem; opacity: 0.6;"></i>
        </div>
    </div>

    <div class="pb-4" style="padding-left: 35px; padding-right: 25px;">
        <h1 class="fw-bolder mt-2" style="font-size: calc(1.375rem + 1.5vw); line-height: 1.2;">지금 참여하고<br><strong>포인트를 쌓아보세요</strong></h1>
    </div>

    <div id="activity-list-container" style="padding-left: 20px; padding-right: 20px;">
        <div class="small text-muted mb-4" style="padding-left: 15px; opacity: 0.8; font-size: 0.85rem;">
            현재 참여 가능한 김녕 마을 정화 퀘스트입니다.
        </div>
        
<div class="dashboard-card mb-3" onclick="openSubmit('김녕 성세기해변 플로깅', 2000, '...')" 
     style="padding: 22px; align-items: center; border-left: 5px solid var(--primary); margin: 0 0 15px 0; width: 100%;
            animation: breathe 2s infinite ease-in-out; /* 엔진 점화 */">
    <div style="flex: 1;">
        <div class="fw-bold" style="font-size: 1.1rem;">김녕 성세기해변 플로깅</div>
        <div class="text-success small fw-bold" style="margin-top: 4px;">+3,000 포인트 적립</div>
    </div>
    <i class="bi bi-chevron-right fs-4" style="color: #ccc;"></i>
</div>

        </div>
</div>

    <div id="page-submit-act" class="page">
    <div class="top-nav">
        <div onclick="showPage('page-main')" style="cursor: pointer;">
            <img src="https://gnpay.my/log.png" style="width: 85px; margin-bottom: 8px;">
            <div id="act-title-display" style="color:var(--primary); font-weight:900; font-size:1.4rem; letter-spacing:-0.5px; margin-bottom: 5px; margin-left: 10px;">환경 정화 인증</div>
        </div>
        <div class="fs-2 text-secondary" style="cursor:pointer; padding: 10px;" onclick="showPage('page-main')">
            <i class="bi bi-x-lg" style="font-size: 1.5rem; opacity: 0.6;"></i>
        </div>
    </div>

    <div class="pb-4" style="padding-left: 35px; padding-right: 25px;">
        <h1 class="fw-bolder mt-2" style="font-size: calc(1.375rem + 1.5vw); line-height: 1.2;">깨끗한 김녕을 위해<br><strong>활동을 인증해주세요</strong></h1>
    </div>

    <div style="padding-left: 20px; padding-right: 20px;">
        <div id="act-desc-display" class="small text-muted mb-4" style="padding-left: 15px; opacity: 0.8; font-size: 0.85rem;">
            활동 사진과 간단한 소감을 남겨주시면 확인 후 포인트를 드립니다.
        </div>
        
        <div class="p-1">
            <textarea id="act-content" class="form-control custom-input" rows="4" placeholder="오늘 어떤 정화 활동을 하셨나요?" style="border-radius: 20px; border: 1px solid #eee; margin-bottom: 15px;"></textarea>
            
            <div class="mb-2 small fw-bold text-muted" style="margin-left: 10px;">사진 첨부 (최대 3장)</div>
            <input type="file" id="act-files" class="form-control custom-input" accept="image/*" multiple onchange="previewImages()" style="border-radius: 20px; border: 1px solid #eee; margin-bottom: 15px;">
            
            <div id="image-preview" class="d-flex gap-2 mb-4 overflow-auto pb-2" style="padding-left: 5px;"></div>
            
            <button class="btn-scan w-100" onclick="submitActivity()" style="height: 60px; font-size: 1.2rem;">인증 신청하기</button>
        </div>
    </div>
</div>

  <div id="page-partners" class="page">
    <div class="top-nav">
        <div onclick="showPage('page-main')" style="cursor: pointer;">
            <img src="https://gnpay.my/log.png" style="width: 85px; margin-bottom: 8px;">
            <div style="color:var(--primary); font-weight:900; font-size:1.4rem; letter-spacing:-0.5px; margin-bottom: 5px; margin-left: 10px;">포인트 가맹점</div>
        </div>
        <div class="fs-2 text-secondary" style="cursor:pointer; padding: 10px;" onclick="showPage('page-main')">
            <i class="bi bi-x-lg" style="font-size: 1.5rem; opacity: 0.6;"></i>
        </div>
    </div>

    <div class="pb-4" style="padding-left: 35px; padding-right: 25px;">
        <h1 class="fw-bolder mt-2" style="font-size: calc(1.375rem + 1.5vw); line-height: 1.2;">어디서나 자유롭게<br><strong>포인트를 사용하세요</strong></h1>
    </div>

    <div style="padding-left: 20px; padding-right: 20px;">
        <div class="small text-muted mb-4" style="padding-left: 15px; opacity: 0.8; font-size: 0.85rem;">
            김녕페이 포인트를 현금처럼 사용할 수 있는 가맹점입니다.
        </div>
        
      <div class="dashboard-card mb-3" 
     style="padding: 22px; flex-direction: column; align-items: flex-start; border-left: 5px solid var(--primary); margin: 0 0 15px 0; width: 100%;
            animation: breathe 2s infinite ease-in-out; /* 엔진 점화 */">
    <div class="fw-bold" style="font-size: 1.1rem;">김녕수산문화복합센터</div>
    <div class="small text-muted mt-1">📍 각종 체험 활동 · 2층 해녀삼춘커피</div>
</div>

<div class="dashboard-card mb-3" 
     style="padding: 22px; flex-direction: column; align-items: flex-start; border-left: 5px solid var(--primary); margin: 0 0 15px 0; width: 100%;
            animation: breathe 2s infinite ease-in-out; /* 엔진 점화 */">
    <div class="fw-bold" style="font-size: 1.1rem;">김녕어울림센터</div>
    <div class="small text-muted mt-1">📍 각종 체험 활동 · 1층 삼춘카페 등</div>
</div>
<div class="dashboard-card mb-3" 
     style="padding: 22px; flex-direction: column; align-items: flex-start; border-left: 5px solid var(--primary); margin: 0 0 15px 0; width: 100%;
            animation: breathe 2s infinite ease-in-out;">
    <div class="fw-bold" style="font-size: 1.1rem;">카페, 청굴물</div>
    <div class="small text-muted mt-1">📍 각종 음료 및 디저트 · 각종 굿즈</div>
</div>
    </div>
</div>

    <div class="floating-tab-bar">
        <div class="tab-item active" onclick="showPage('page-main'); updateTab(this)">
            <i class="bi bi-house-door-fill"></i>
            <span>홈</span>
        </div>
       <div class="tab-item" onclick="showPage('page-partners'); updateTab(this)">
    <i class="bi bi-shop"></i> <span>가맹점</span>
</div>
        <div class="tab-scan-btn" onclick="handleScan()">
            <i class="bi bi-qr-code-scan"></i>
        </div>
        <div class="tab-item" onclick="showPage('page-guide'); updateTab(this)">
            <i class="bi bi-info-circle-fill"></i>
            <span>안내</span>
        </div>
        <div class="tab-item" onclick="showPage('page-mypage'); updateTab(this)">
            <i class="bi bi-person-fill"></i>
            <span>내정보</span>
        </div>
    </div>

    <div id="scanner-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:20000;">
        <div id="reader" style="width:100%; height:80vh;"></div>
        <button class="btn btn-light" style="position:absolute; bottom:50px; left:50%; transform:translateX(-50%);" onclick="closeScanner()">닫기</button>
    </div>
<div id="page-ranking" class="page">
    <div class="top-nav">
        <div onclick="showPage('page-main')" style="cursor: pointer;">
            <img src="https://gnpay.my/log.png" style="width: 85px; margin-bottom: 8px;">
            <div style="color:var(--primary); font-weight:900; font-size:1.4rem; letter-spacing:-0.5px; margin-bottom: 5px; margin-left: 10px;">수호자 랭킹</div>
        </div>
        <div class="fs-2 text-secondary" style="cursor:pointer; padding: 10px;" onclick="showPage('page-main')">
            <i class="bi bi-x-lg" style="font-size: 1.5rem; opacity: 0.6;"></i>
        </div>
    </div>

    <div class="d-flex px-4 mt-2 mb-4" style="gap: 10px;">
        <div id="tab-rank-today" class="flex-fill text-center py-2 active-tab" onclick="switchRankTab('today')" style="cursor:pointer; font-weight:800; border-radius:15px; font-size:0.9rem;">오늘의 랭킹</div>
        <div id="tab-rank-total" class="flex-fill text-center py-2 inactive-tab" onclick="switchRankTab('total')" style="cursor:pointer; font-weight:800; border-radius:15px; font-size:0.9rem;">전체 랭킹</div>
    </div>

    <div style="padding-left: 20px; padding-right: 20px;">
        <div id="ranking-list">
            <div class="text-center text-muted mt-5 small">랭킹 정보를 불러오는 중...</div>
        </div>
    </div>
</div>
<div class="walk-path">
    <img id="walking-harry" src="https://gnpay.my/harry_walk.gif" onerror="this.src='https://gnpay.my/3dlog.png'">
</div>
</body>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycby6C0tEYO3LYB2LrTEQwW2W5kzA5JiTgs1UVserc_w8g7vsfcvGM-5Qlt7QPv9Zc5-oDg/exec";
function updateTab(element) {
    document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
    element.classList.add('active');

    const tabName = element.querySelector('span')?.innerText;
    
    if (tabName === '내정보') {
        refreshUserData(); 
        showPage('page-mypage'); 
        
        if (userData && userData.isLoggedIn) {
            setTimeout(() => {
                /* ... (기존 마이페이지 데이터 채우기 코드는 그대로 유지) ... */
                const nameDisplay = document.getElementById('mypage-user-name');
                if (nameDisplay) nameDisplay.innerText = userData.name || "사용자";
                const myPointEl = document.getElementById('my-u-points');
                if (myPointEl) animateValue('my-u-points', 0, Number(userData.points || 0), 1000);
                const qrImg = document.getElementById('my-qr-img');
                if (qrImg && userData.uid) qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${userData.uid}`;
            }, 50);
        }
    }
    // [▼ 여기를 수정했습니다!]
    else if (tabName === '가맹점') {
        showPage('page-partners');
    }
    else if (tabName === '홈') {
        showPage('page-main');
    }
    else if (tabName === '안내') {
        showPage('page-guide');
    }
}
        let userData = JSON.parse(localStorage.getItem('gnpay_user')) || { isLoggedIn: false, points: 0 };
        let selectedImages = [];
        let currentAct = { title: "", amount: 0 };
        const loading = document.getElementById('loading-overlay');
        let html5QrCode;

function showPage(pageId) {
    const targetPage = document.getElementById(pageId);
    const currentPage = document.querySelector('.page.active');

    // 1. 타겟이 없거나 이미 그 페이지면 즉시 중단
    if (!targetPage || currentPage === targetPage) return;

    // 🌟 [추가] 마이페이지 진입 시 로그인 상태에 따라 내부 화면 미리 세팅
    if (pageId === 'page-mypage') {
        syncMypageState(); 
    }
const walkPath = document.querySelector('.walk-path');
    if (walkPath) {
        // 로그인(page-login)이나 회원가입(page-signup) 페이지일 때만 숨김
        const isAuthPage = ['page-login', 'page-signup'].includes(pageId);
        walkPath.style.display = isAuthPage ? 'none' : 'block';
    }
    // 2. 방향 계산 (currentPage가 없을 때를 대비해 기본값 -1 설정)
    const order = ['page-login', 'page-signup', 'page-main', 'page-history', 'page-guide', 'page-mypage'];
    const curIdx = currentPage ? order.indexOf(currentPage.id) : -1;
    const nextIdx = order.indexOf(pageId);

    // 3. 입력창 잠금
    document.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);

    // 4. [기존 페이지 처리] 
    if (currentPage) {
        currentPage.classList.remove('active');
        currentPage.style.transition = 'transform 0.35s ease-out, opacity 0.35s ease-out';
        currentPage.style.transform = nextIdx > curIdx ? 'translateX(-100%)' : 'translateX(100%)';
        currentPage.style.opacity = '0';
        
        const prevPage = currentPage;
        setTimeout(() => {
            if (!prevPage.classList.contains('active')) {
                prevPage.style.display = 'none';
                prevPage.style.transform = 'none';
            }
        }, 350);
    }

    // 5. [타겟 페이지 등장]
    targetPage.style.display = 'block';
    targetPage.style.transition = 'none'; 
    
    const startX = nextIdx > curIdx ? '100%' : '-100%';
    targetPage.style.transform = `translateX(${startX})`;
    targetPage.style.opacity = '0';
    
    void targetPage.offsetWidth; 

    requestAnimationFrame(() => {
        targetPage.style.transition = 'transform 0.4s cubic-bezier(0.1, 0.9, 0.2, 1), opacity 0.3s ease';
        targetPage.classList.add('active');
        targetPage.style.transform = 'translateX(0)';
        targetPage.style.opacity = '1';
    });

    // 6. 마무리 (UI 업데이트 및 하단바)
    setTimeout(() => {
        targetPage.querySelectorAll('input, select, textarea').forEach(el => el.disabled = false);
        // 🌟 updateUI 내부에 syncMypageState()를 포함시키면 더 완벽합니다.
        if (pageId === 'page-main' || pageId === 'page-mypage') updateUI();
    }, 400);

    // 7. 하단바 제어 (지혜로운 방식: 마이페이지에선 무조건 노출)
    const tabBar = document.querySelector('.floating-tab-bar');
    if (tabBar) {
        const isAuthPage = ['page-login', 'page-signup'].includes(pageId);
        tabBar.style.display = isAuthPage ? 'none' : 'flex';
        if (typeof syncTabBar === "function") syncTabBar(pageId);
    }
    
    window.scrollTo(0, 0);
}

function syncMypageState() {
    // [수정] localStorage의 엉뚱한 키 대신, 현재 로드된 userData 객체의 상태를 확인합니다.
    const isLogined = userData && userData.isLoggedIn; 
    
    const guestContent = document.getElementById('mypage-guest-content');
    const userContent = document.getElementById('mypage-user-content');
    const authButtons = document.getElementById('mypage-auth-buttons');

    if (!isLogined) {
        // 비로그인: 게스트 화면 노출 (여기에 '로그인 하러가기' 버튼이 있음)
        if(guestContent) guestContent.style.display = 'flex';
        if(userContent) userContent.style.display = 'none';
        if(authButtons) authButtons.style.display = 'none';
    } else {
        // 로그인: 회원 카드 노출
        if(guestContent) guestContent.style.display = 'none';
        if(userContent) userContent.style.display = 'block';
        if(authButtons) authButtons.style.display = 'flex';
    }
}
function updateUI() {
    const authArea = document.getElementById('auth-area');
    const welcome = document.getElementById('welcome-message');
    const pointDisplay = document.getElementById('main-u-points');
    const qrTrigger = document.getElementById('qr-trigger');
    
    const rankLabel = document.getElementById('mypage-rank-label');

    syncMypageState(); 

    if (userData.isLoggedIn) {
        const currentRankKey = getRankByPoints(userData.points);
        
        // [🔥 절대 에러 안나는 색상 데이터 창고]
        const rankData = {
            'GUEST':  { text: 'GIMNYEONG PAY', color: 'linear-gradient(145deg, #ffffff, #e6e6e6)', textColor: '#333' },
            '보말':   { text: '김녕 보말 🐚', color: 'linear-gradient(145deg, #ffdee9, #b5fffc)', textColor: '#333' },
            '감자':   { text: '김녕 감자 🌊', color: 'linear-gradient(145deg, #e1b382, #c89666)', textColor: '#fff' },
            '당근':   { text: '김녕 당근 💎', color: 'linear-gradient(145deg, #ff9a9e, #fecfef)', textColor: '#fff' },
            '돌고래': { text: '김녕 돌고래 🐬', color: 'linear-gradient(145deg, #01b2ad, #00d2ff)', textColor: '#fff' },
            '해녀':   { text: '전설의 해녀 👑', color: 'linear-gradient(145deg, #667eea, #764ba2)', textColor: '#fff' }
        };

        // 1. 현재 등급 뱃지 업데이트 (유저 이름 위)
        if (rankLabel) {
            const data = rankData[currentRankKey] || rankData['GUEST'];
            rankLabel.innerText = data.text;
            rankLabel.style.display = 'inline-block';
            rankLabel.style.padding = '4px 14px';
            rankLabel.style.borderRadius = '15px';
            rankLabel.style.background = data.color;
            rankLabel.style.color = data.textColor;
            rankLabel.style.fontSize = '0.75rem';
            rankLabel.style.fontWeight = '900';
            rankLabel.style.boxShadow = '0 4px 10px rgba(0,0,0,0.08)';
            rankLabel.style.marginBottom = '8px';
        }

        const points = Number(userData.points || 0);
        const ranks = [
    { id: '보말', name: '김녕 보말 🐚', pt: 0 },
    { id: '감자', name: '김녕 감자 🥔', pt: 1000 },
    { id: '당근', name: '김녕 당근 🥕', pt: 3000 },
    { id: '돌고래', name: '김녕 돌고래 🐬', pt: 5000 },
    { id: '해녀', name: '전설의 해녀 👑', pt: 10000 }
];

        const nextRank = ranks.find(r => r.pt > points);
        const currentRankData = [...ranks].reverse().find(r => r.pt <= points);

        const gaugeFill = document.querySelector('#page-mypage #pop-gauge-bar'); 
        const nextInfoNum = document.querySelector('#page-mypage #pop-next-info');
        const nextRankTitle = document.querySelector('#page-mypage #pop-rank-badge-text');

        if (nextRank) {
            const range = nextRank.pt - currentRankData.pt;
            const progress = points - currentRankData.pt;
            const percent = Math.min(Math.floor((progress / range) * 100), 100);
            
            if (gaugeFill) gaugeFill.style.width = percent + "%";
            
            // [🔥 수리 포인트] 다음 등급 텍스트에 고유 뱃지 색상 입히기
            if (nextRankTitle) {
                const nextData = rankData[nextRank.id] || rankData['GUEST'];
                nextRankTitle.innerText = nextRank.name;
                nextRankTitle.style.display = 'inline-block';
                nextRankTitle.style.padding = '3px 12px';
                nextRankTitle.style.borderRadius = '12px';
                nextRankTitle.style.background = nextData.color; // 다음 등급 색상 주입
                nextRankTitle.style.color = nextData.textColor;
                nextRankTitle.style.fontSize = '0.8rem';
                nextRankTitle.style.fontWeight = '900';
                nextRankTitle.style.boxShadow = '0 2px 6px rgba(0,0,0,0.1)';
            }

            if (nextInfoNum) {
                const diff = nextRank.pt - points;
                animateValue('pop-next-info', 0, diff, 1000);
            }
        } else {
            if (gaugeFill) gaugeFill.style.width = "100%";
            if (nextRankTitle) {
                nextRankTitle.innerText = "최고 등급 달성! 👑";
                nextRankTitle.style.background = 'linear-gradient(145deg, #FFD700, #FFA500)';
                nextRankTitle.style.color = '#fff';
                nextRankTitle.style.padding = '3px 12px';
                nextRankTitle.style.borderRadius = '12px';
            }
            if (nextInfoNum) nextInfoNum.innerText = "0";
        }

        updateHarryCharacter(currentRankKey);

        authArea.innerHTML = `<span class="auth-link" style="color:var(--primary); font-weight:800;" onclick="showPage('page-mypage')">${userData.name}님</span><span style="color:#eee; font-size:0.7rem;">|</span><span class="auth-link" onclick="logout()">로그아웃</span>`;
        welcome.innerHTML = `${userData.name}님, 반갑습니다!<br><strong>김녕을 지켜주세요!</strong>`;
        
        const targetPoints = Number(userData.points || 0);
        animateValue('main-u-points', 0, targetPoints, 1000);
        animateValue('my-u-points', 0, targetPoints, 1000); 

        const myName = document.getElementById('mypage-user-name');
        if(myName) myName.innerText = userData.name;

        const myQr = document.getElementById('my-qr-img');
        if(myQr) myQr.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${userData.uid}`;

        qrTrigger.onclick = (e) => {
            const tabBar = document.querySelector('.floating-tab-bar');
            if (tabBar) tabBar.style.display = 'none';
            document.getElementById('qr-focus-layer').style.display = 'flex';
            animateValue('focus-points', 0, targetPoints, 1000);
            document.getElementById('qr-img-large').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${userData.uid}`;
        };
        
        if (qrTrigger) {
            qrTrigger.style.animation = "none";
            void qrTrigger.offsetWidth;
            qrTrigger.style.animation = "breathe 2s infinite ease-in-out";
        }
        
        updateActivityBadge();

        if (!window.pointSyncInterval) {
            window.pointSyncInterval = setInterval(syncPointsRealtime, 5000);
        }
    } else {
        updateHarryCharacter('GUEST');
        if (rankLabel) {
            rankLabel.innerText = "GIMNYEONG PAY";
            rankLabel.style.background = 'none';
            rankLabel.style.padding = '0';
            rankLabel.style.boxShadow = 'none';
            rankLabel.style.color = 'var(--primary)';
        }
        authArea.innerHTML = `<span class="auth-link" onclick="showPage('page-signup')">회원가입</span><span style="color:#eee; font-size:0.7rem;">|</span><span class="auth-link text-dark" onclick="showPage('page-login')">로그인</span>`;
        welcome.innerHTML = `제주에서 함께 하는<br><strong>탄소중립 실천</strong>`;
        if (pointDisplay) {
            pointDisplay.innerHTML = `<span style="font-size: 0.95rem; font-weight: 800; color: var(--primary);" onclick="showPage('page-login')">로그인 후 이용하세요 <i class="bi bi-chevron-right"></i></span>`;
        }
        qrTrigger.onclick = () => showPage('page-login');
    }
}
// 마이페이지 진입 시마다 상태 체크해서 화면 스위칭


// showPage('page-mypage') 할 때 이 함수를 실행하게 걸어주면 끝!

// [추가] 배지 숫자를 실제로 계산하고 보여주는 함수
function updateActivityBadge() {
    // 1. 숫자를 표시할 빨간 동그라미 요소를 가져옵니다.
    const badge = document.getElementById('activity-badge-count');
    // 2. 사장님이 만드신 활동 리스트 컨테이너를 가져옵니다.
    const container = document.getElementById('activity-list-container');
    
    if (badge && container) {
        // 컨테이너 안에 있는 'dashboard-card' 개수를 세어봅니다.
        const count = container.querySelectorAll('.dashboard-card').length;
        
        if (count > 0) {
            badge.innerText = count;  // 개수를 배지에 입력
            badge.style.display = 'flex'; // 배지 보이기
        } else {
            badge.style.display = 'none'; // 개수가 0이면 숨기기
        }
    }
}

async function syncPointsRealtime() {
    if (!userData.isLoggedIn) return;
    try {
        const res = await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ type: 'login', email: userData.email, password: userData.password })
        }).then(r => r.json());

        if (res.result === 'success') {
            userData.points = res.user.points;
            localStorage.setItem('gnpay_user', JSON.stringify(userData));
            
            // 1. 화면의 숫자(포인트) 업데이트
            document.querySelectorAll('.user-points-display').forEach(el => {
                el.innerText = Number(res.user.points).toLocaleString();
            });

            // ---------------------------------------------------
            // [지훈이의 엔진 추가] 백그라운드에서 포인트가 변하면 해리도 즉시 갱신!
            const currentRank = getRankByPoints(res.user.points);
            updateHarryCharacter(currentRank);
            // ---------------------------------------------------
        }
    } catch (e) { console.log("sync..."); }
}
function goToMyPage() {
    // 1. 마이페이지로 화면 전환
    showPage('page-mypage');
    
    // 2. [핵심] 로그인된 사용자의 실제 이름을 화면에 박아넣기
    const nameDisplay = document.getElementById('mypage-user-name');
    if (nameDisplay && userData.name) {
        nameDisplay.innerText = userData.name;
    }

    // 3. 포인트 정보 업데이트
    const pointDisplay = document.getElementById('my-u-points');
    if (pointDisplay) {
        pointDisplay.innerText = Number(userData.points || 0).toLocaleString();
    }

    // 4. QR 코드 생성 (사용자 UID 기반)
    const qrImg = document.getElementById('my-qr-img');
    if (qrImg && userData.uid) {
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${userData.uid}`;
    }
}

    // 4. QR 코드 생성
    document.getElementById('my-qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${userData.uid}`;


       async function submitLogin() {
    // [칼각 유지] 형님이 쓰시는 ID 그대로 가져옵니다
    const email = document.getElementById('login-email').value;
    const pw = document.getElementById('login-pw').value;
    
    if(!email || !pw) return alert("입력해주세요.");
    loading.style.display='flex';
    
    try {
        const res = await fetch(GAS_URL, { 
            method: 'POST', 
            body: JSON.stringify({ type: 'login', email, password: pw }) 
        }).then(r => r.json());

        if (res.result === 'success') {
            // [지훈이의 엔진 추가] 아이디 기억하기 체크 여부 확인
            const rememberMe = document.getElementById('remember-me').checked;
            if (rememberMe) {
                localStorage.setItem('gnpay_remember_email', email);
            } else {
                localStorage.removeItem('gnpay_remember_email');
            }

            userData = { isLoggedIn: true, ...res.user, password: pw };
            localStorage.setItem('gnpay_user', JSON.stringify(userData));
            updateUI();
            showPage('page-main');
        } else { 
            alert(res.message); 
        }
    } catch (e) { 
        alert("로그인 오류"); 
    }
    loading.style.display='none';
}
        async function submitSignup() {
            const data = { type: 'signup', name: document.getElementById('reg-name').value, email: document.getElementById('reg-email').value, password: document.getElementById('reg-pw').value, phone: document.getElementById('reg-phone').value };
            loading.style.display='flex';
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(data) }).then(r => r.json());
                if (res.result === 'success') { alert("가입 성공!"); showPage('page-login'); } else { alert(res.message); }
            } catch (e) { alert("회원가입 오류"); }
            loading.style.display='none';
        }

        function openSubmit(title, amount, desc) {
            if (!userData.isLoggedIn) return showPage('page-login');
            currentAct = { title, amount };
            document.getElementById('act-title-display').innerText = title;
            document.getElementById('act-desc-display').innerHTML = desc || "활동 내용을 인증하세요.";
            showPage('page-submit-act');
        }

        // [새로 추가하는 함수] 이메일 주소를 입력받아 서버(GAS)에 임시비번 요청을 보냅니다.
// 1. 팝업 열기 (기존의 prompt 대신 이걸 실행)

function updateMypageGauge() {
    if (!userData.isLoggedIn) return;

    const points = Number(userData.points || 0);
    const ranks = [
        { id: '몽돌', name: '김녕 보말 🐚', pt: 0 },
        { id: '파도', name: '김녕 감자 🥔', pt: 1000 },
        { id: '심해', name: '김녕 당근 🥕', pt: 3000 },
        { id: '수호신', name: '김녕 돌고래 🐬', pt: 5000 },
        { id: '전설', name: '전설의 해녀 👑', pt: 10000 }
    ];

    const currentRankIdx = [...ranks].reverse().findIndex(r => r.pt <= points);
    const nextRank = ranks.find(r => r.pt > points);

    const gaugeBar = document.getElementById('pop-gauge-bar');
    const badgeText = document.getElementById('pop-rank-badge-text'); // ID 수정됨
    const nextInfo = document.getElementById('pop-next-info');

    if (nextRank) {
        const currentRankPt = ranks[ranks.length - 1 - currentRankIdx].pt;
        const percent = Math.floor(((points - currentRankPt) / (nextRank.pt - currentRankPt)) * 100);
        
        if (gaugeBar) gaugeBar.style.width = percent + "%";
        if (badgeText) badgeText.innerText = nextRank.name; // 다음 목표 등급 이름
        if (nextInfo) animateValue('pop-next-info', 0, nextRank.pt - points, 1000);
    } else {
        if (gaugeBar) gaugeBar.style.width = "100%";
        if (badgeText) badgeText.innerText = "최고 등급 달성! 👑";
        if (nextInfo) nextInfo.innerText = "0";
    }
}
function handleForgotPassword() {
    const layer = document.getElementById('pw-reset-layer');
    if(layer) {
        layer.style.display = 'flex';
        
        // [수정 핵심] 여기도 팝업 열릴 때 잠금 해제 추가
        layer.querySelectorAll('input').forEach(el => el.disabled = false);

        document.getElementById('reset-email').value = '';
        document.getElementById('reset-phone').value = '';
    }
}

// 2. 실제 서버 전송 (쫀득한 버튼 클릭 시 실행)
async function processPwReset() {
    const email = document.getElementById('reset-email').value;
    const phone = document.getElementById('reset-phone').value;

    if (!email || !phone) return alert("정보를 모두 입력해주세요!");

    loading.style.display = 'flex';
    try {
        const res = await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                type: 'requestPwReset', 
                email: email, 
                phone: phone.replace(/[^0-9]/g, "") 
            })
        }).then(r => r.json());

        if (res.result === 'success') {
            alert("정보가 확인되었습니다!\n메일로 임시 비밀번호를 보냈습니다.");
            document.getElementById('pw-reset-layer').style.display = 'none';
        } else {
            alert(res.message);
        }
    } catch (e) {
        alert("서버 연결 실패");
    }
    loading.style.display = 'none';
}
async function previewImages() {
    const fileInput = document.getElementById('act-files');
    const previewContainer = document.getElementById('image-preview');
    const files = fileInput.files;
    
    if (files.length === 0) return;

    previewContainer.innerHTML = ''; // 기존 미리보기 지우기
    selectedImages = []; // 저장소 초기화
    
    loading.style.display = 'flex'; // 압축 시작하니 로딩바 띄우기

    const options = {
        maxSizeMB: 0.5,          // 0.5MB까지 압축
        maxWidthOrHeight: 1280, // 가로세로 최대 1280px
        useWebWorker: true
    };

    try {
        for (let i = 0; i < files.length; i++) {
            // [핵심] 여기서 사장님이 가져온 라이브러리가 압축을 진행합니다
            const compressedFile = await imageCompression(files[i], options);
            
            const reader = new FileReader();
            reader.readAsDataURL(compressedFile);
            
            await new Promise((resolve) => {
                reader.onloadend = () => {
                    const base64data = reader.result;
                    selectedImages.push(base64data);
                    
                    const img = document.createElement('img');
                    img.src = base64data;
                    img.className = 'history-img'; // 사장님 기존 스타일 유지
                    img.style.width = '80px';
                    img.style.height = '80px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '12px';
                    previewContainer.appendChild(img);
                    resolve();
                };
            });
        }
    } catch (error) {
        console.error(error);
        alert("이미지 압축 중 오류가 발생했습니다.");
    } finally {
        loading.style.display = 'none'; // 압축 끝났으니 로딩바 끄기
    }
}
        async function submitActivity() {
            const content = document.getElementById('act-content').value;
            if(!content || selectedImages.length === 0) return alert("활동 내용과 사진을 등록해주세요.");
            loading.style.display='flex';
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'submitActivity', email: userData.email, title: currentAct.title, content: content, images: selectedImages, pointAmount: currentAct.amount }) }).then(r => r.json());
                if(res.result === 'success') { alert("신청이 완료되었습니다!"); showPage('page-main'); }
                else { alert("오류: " + res.message); }
            } catch(e) { alert("서버 통신 오류"); }
            loading.style.display='none';
        }

   // [최종] 내역 조회 함수: 서버에서 장부와 신청내역을 동시에 가져옴
async function loadActivityHistory() {
    showPage('page-history');
    switchHistoryTab('point'); 

    const pointList = document.getElementById('point-history-list');
    const activityList = document.getElementById('activity-history-list');
    
    pointList.innerHTML = '<div class="text-center p-4 small text-muted">데이터 동기화 중...</div>';
    activityList.innerHTML = '<div class="text-center p-4 small text-muted">데이터 동기화 중...</div>';

    try {
        const response = await fetch(GAS_URL, { 
            method: 'POST', 
            body: JSON.stringify({ 
                type: 'login', 
                email: userData.email, 
                password: userData.password 
            }) 
        });
        const res = await response.json();

        if (res.result === 'success') {
            const pLogs = res.user.history || [];       // PointLogs 데이터
            const aLogs = res.user.applications || [];  // Applications 데이터

            let pHtml = '';
            let aHtml = '';

            // 1. 포인트 내역 빌드 (장부 데이터)
if (pLogs.length > 0) {
    pLogs.forEach(log => {
        const isPlus = Number(log.amount) > 0;
        pHtml += `
            <div class="dashboard-card mb-3" style="padding:18px; border-left:5px solid ${isPlus ? 'var(--primary)' : '#ff4d4d'}; width:100%; margin:0 0 12px 0; cursor:default;
                animation: breathe 2s infinite ease-in-out; /* [핵심] 숨쉬기 애니메이션 강제 주입 */
            ">
                <div style="flex:1;">
                    <div class="fw-bold" style="font-size:1rem;">${log.title}</div>
                    <div class="small text-muted">${log.date}</div>
                </div>
                <div class="fw-bold" style="color:${isPlus ? 'var(--primary)' : '#ff4d4d'}">
                    ${isPlus ? '+' : ''}${Number(log.amount).toLocaleString()} P
                </div>
            </div>`;
    });
}

            // 2. 활동 현황 빌드 (사진 펼치기 기능 탑재)
if (aLogs.length > 0) {
    aLogs.forEach((app, idx) => {
        const s = app.status || '대기';
        // 승인이면 초록(var(--primary)), 반려면 빨강(#ff4d4d), 대기면 노랑(#ffcc00)
        const sColor = s === '승인' ? 'var(--primary)' : (s === '반려' ? '#ff4d4d' : '#ffcc00');
        
        // 사진 데이터 확보
        const pic1 = app.img1 || app.사진1 || app.photo1;
        const pic2 = app.img2 || app.사진2 || app.photo2;
        const pic3 = app.img3 || app.사진3 || app.photo3;

        aHtml += `
            <div class="dashboard-card mb-3" style="padding:18px; border-left:5px solid ${sColor}; flex-direction:column; align-items:flex-start; cursor:pointer;" 
                 onclick="const d = document.getElementById('detail-${idx}'); d.style.display = (d.style.display === 'none' ? 'block' : 'none')">
                
                <div class="d-flex justify-content-between w-100 align-items-center">
                    <div style="flex:1;">
                        <div class="fw-bold" style="font-size:1rem; color:#333;">${app.title}</div>
                        <div class="small text-muted">${app.date}</div>
                    </div>
                    <div class="text-end">
                        <div class="badge mb-1" style="background:${sColor}; color:white; border-radius:8px; font-size:0.7rem; padding:4px 10px;">${s}</div>
                        ${s === '승인' ? `<div class="fw-bold" style="color:var(--primary); font-size:0.9rem;">+${Number(app.points).toLocaleString()} P</div>` : ''}
                    </div>
                </div>

                <div id="detail-${idx}" style="display:none; width:100%; margin-top:15px; border-top:1px dashed #eee; padding-top:15px;">
                    <div class="row g-2 mb-3">
                        ${pic1 ? `<div class="col-4"><img src="${pic1}" class="img-fluid rounded-3 shadow-sm" style="aspect-ratio:1; object-fit:cover;"></div>` : ''}
                        ${pic2 ? `<div class="col-4"><img src="${pic2}" class="img-fluid rounded-3 shadow-sm" style="aspect-ratio:1; object-fit:cover;"></div>` : ''}
                        ${pic3 ? `<div class="col-4"><img src="${pic3}" class="img-fluid rounded-3 shadow-sm" style="aspect-ratio:1; object-fit:cover;"></div>` : ''}
                    </div>

                    ${s === '반려' ? `
                        <div style="background:#fff5f5; padding:12px; border-radius:12px; border:1px solid #ffe3e3;">
                            <div class="d-flex justify-content-between align-items:center;">
                                <span class="small text-muted">포인트 획득 실패</span>
                                <span class="fw-bold" style="color:#ff4d4d; text-decoration:line-through;">+${Number(app.points).toLocaleString()} P</span>
                            </div>
                            ${app.message ? `<div class="mt-2 small" style="color:#e03131;"><strong>사유:</strong> ${app.message}</div>` : ''}
                        </div>
                    ` : `
                        <div class="small text-muted text-center py-2" style="background:#f8f9fa; border-radius:10px;">
                            ${s === '승인' ? '정상 승인된 활동입니다.' : '관리자가 확인 중입니다.'}
                        </div>
                    `}
                </div>
            </div>`;
    });
}

            pointList.innerHTML = pHtml || '<div class="text-center text-muted mt-5 small">포인트 기록이 없습니다.</div>';
            activityList.innerHTML = aHtml || '<div class="text-center text-muted mt-5 small">활동 신청 기록이 없습니다.</div>';
            
            userData.points = res.user.points;
            localStorage.setItem('gnpay_user', JSON.stringify(userData));
            updateUI();
        }
    } catch (e) {
        console.error(e);
        pointList.innerHTML = '<div class="text-center text-muted mt-5 small">서버 연결에 실패했습니다.</div>';
    }
}
// 정보 수정 버튼 눌렀을 때 실행되는 함수
// 정보 수정 버튼 눌렀을 때 실행되는 함수
function openEditInfo() {
    const layer = document.getElementById('profile-edit-layer');
    if (layer) {
        layer.style.display = 'flex';
        
        // [수정 핵심] 팝업이 열릴 때, 억지로 잠겨있던 입력창들을 깨워줍니다.
        layer.querySelectorAll('input, select').forEach(el => el.disabled = false);
        
        if (userData) {
            // 사장님 요청: 팝업 제목에 이름 넣기
            const nameTarget = document.getElementById('edit-user-name');
            if (nameTarget) nameTarget.innerText = userData.name || "사용자";

            // 기존 정보 채우기
            const regionSelect = document.getElementById('popup-edit-region');
            const phoneInput = document.getElementById('popup-edit-phone');

            if(regionSelect) regionSelect.value = userData.region || "제주";
            if(phoneInput) phoneInput.value = userData.phone || "";
        }
        // 비밀번호 칸은 비워두기
        const pwInput = document.getElementById('popup-edit-pw');
        if(pwInput) pwInput.value = "";
    }
}
// 팝업 안에서 '수정완료' 눌렀을 때 실행되는 함수
async function submitPopupEdit() {
    const newRegion = document.getElementById('popup-edit-region').value;
    const newPhone = document.getElementById('popup-edit-phone').value;
    const newPw = document.getElementById('popup-edit-pw').value;

    if(!newPhone) return alert("전화번호를 입력해주세요.");

    loading.style.display = 'flex';
    try {
        const res = await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({
                type: 'updateUserInfo',
                email: userData.email,
                newPhone: newPhone,
                newPw: newPw,
                newRegion: newRegion,
                newGender: userData.gender // 기존 정보 유지
            })
        }).then(r => r.json());

        if(res.result === 'success') {
            alert("정보가 수정되었습니다. 😊");
            
            // 내 폰의 로컬 데이터도 즉시 갱신
            userData.phone = newPhone;
            userData.region = newRegion;
            if(newPw) userData.password = newPw;
            
            localStorage.setItem('gnpay_user', JSON.stringify(userData));
            
            // 팝업 닫기
            document.getElementById('profile-edit-layer').style.display = 'none';
        } else {
            alert("수정 실패: " + res.message);
        }
    } catch(e) {
        alert("서버 연결 실패. 다시 시도해 주세요!");
    }
    loading.style.display = 'none';
}
async function submitEditInfo() {
    // 1. 화면에서 값 긁어오기
    const newPhone = document.getElementById('edit-phone').value;
    const newPw = document.getElementById('edit-pw').value;
    const newGender = document.getElementById('edit-gender').value; 
    const newRegion = document.getElementById('edit-region').value;

    if(!newPhone) return alert("전화번호를 입력해주세요.");

    loading.style.display = 'flex';
    try {
        // 2. 서버(GAS)에 모든 정보를 실어서 보냄
        const res = await fetch(GAS_URL, { 
            method: 'POST', 
            body: JSON.stringify({ 
                type: 'updateUserInfo', 
                email: userData.email, 
                newPhone: newPhone, 
                newPw: newPw,
                newGender: newGender, 
                newRegion: newRegion  
            }) 
        }).then(r => r.json());

        if(res.result === 'success') {
            alert("정보가 수정되었습니다. 😊");
            
            // 3. 내 폰(메모리) 데이터도 즉시 갱신
            userData.phone = newPhone;
            userData.gender = newGender;
            userData.region = newRegion;
            if(newPw) userData.password = newPw;

            localStorage.setItem('gnpay_user', JSON.stringify(userData));
            showPage('page-mypage');
        } else { 
            alert("수정 실패: " + res.message); 
        }
    } catch(e) { 
        alert("서버와 연결할 수 없습니다. 다시 시도해주세요!"); 
    }
    loading.style.display = 'none';
}
        async function handleScan() {
            if (!userData.isLoggedIn) return showPage('page-login');
            document.getElementById('scanner-modal').style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (text) => {
                closeScanner();
                processAddPoints(100, "현장 QR 인증");
            });
        }
        function closeScanner() { if(html5QrCode) html5QrCode.stop(); document.getElementById('scanner-modal').style.display='none'; }
        
async function processAddPoints(amount, action) {
    loading.style.display = 'flex';
    try {
        const response = await fetch(GAS_URL, { 
            method: 'POST', 
            body: JSON.stringify({ 
                type: 'addPoints', 
                email: userData.email, 
                amount: amount, 
                action: action // "현장 QR 적립" 등이 Description으로 들어감
            }) 
        });
        const res = await response.json();

        if (res.result === 'success') {
            alert(amount + "포인트가 적립되었습니다!");
            
            // 앱 내부 데이터 동기화
            userData.points = res.newPoints;
            
            // 내역 탭을 눌렀을 때 바로 보이게 로컬 배열에도 임시 추가
            if(!userData.pointLogs) userData.pointLogs = [];
            userData.pointLogs.unshift({
                Date: "방금 전",
                Description: action,
                Change: amount
            });

            localStorage.setItem('gnpay_user', JSON.stringify(userData));
            updateUI();
        }
    } catch (e) {
        alert("서버 연결 실패");
    }
    loading.style.display = 'none';
}

        function logout() { if(confirm('로그아웃 하시겠습니까?')) { localStorage.removeItem('gnpay_user'); location.reload(); } }

// [전체 교체] 메인 카드 클릭 시
document.getElementById('qr-trigger').onclick = (e) => {
    if (!userData.isLoggedIn) { showPage('page-login'); return; }
    
    // 하단바 찾아서 확실하게 아래로 200px 던져버리기
    const tabBar = document.querySelector('.floating-tab-bar');
    if (tabBar) {
        tabBar.style.setProperty('transform', 'translateX(-50%) translateY(200px)', 'important');
    }
    
    // QR 팝업 띄우기
    document.getElementById('qr-focus-layer').style.display = 'flex';
    
    const targetVal = Number(userData.points || 0);
    animateValue('focus-points', 0, targetVal, 1000);
    document.getElementById('qr-img-large').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${userData.uid}`;
};

// [전체 교체] 팝업 닫을 때 (닫기 버튼에 onclick="closeQR()" 꼭 넣어주세요!)
// [확인 사살 버전] 딱 하나만 남기세요
function closeQR() {
    // 1. QR 팝업 끄기
    document.getElementById('qr-focus-layer').style.display = 'none';
    
    // 2. 하단바 다시 무조건 살리기 (display 방식을 쓰면 절대 실패 안 합니다)
    const tabBar = document.querySelector('.floating-tab-bar');
    if (tabBar) {
        tabBar.style.setProperty('display', 'flex', 'important');
    }
}
function animateValue(id, start, end, duration) {
    const obj = document.getElementById(id);
    if (!obj) return;
    
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        // 숫자를 콤마(,) 포함해서 예쁘게 찍어줍니다
        obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}
      window.onload = function() {
    // 1. 기존 UI 업데이트 엔진 가동
    updateUI();

    // 2. [지훈이의 엔진 추가] 저장된 아이디가 있으면 불러오기
    const savedEmail = localStorage.getItem('gnpay_remember_email');
    const emailInput = document.getElementById('login-email');
    const rememberCheckbox = document.getElementById('remember-me');

    if (savedEmail && emailInput) {
        emailInput.value = savedEmail;
        if (rememberCheckbox) rememberCheckbox.checked = true;
    }
};
function forceShowPage(pageId) {
    // 1. 모든 페이지를 싹 다 숨깁니다.
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    
    // 2. 가맹점 페이지(page-partners)만 딱 보여줍니다.
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.add('active');
        window.scrollTo(0, 0);
    }
}  
function checkAndSignup() {
    // 1. 입력 요소들 가져오기
    const name = document.getElementById('reg-name').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const pw = document.getElementById('reg-pw').value.trim();
    const phone = document.getElementById('reg-phone').value.trim();
    const gender = document.getElementById('reg-gender').value;
    const region = document.getElementById('reg-region').value;
    const agree = document.getElementById('reg-agree').checked;

    // 2. 빈칸 및 유효성 체크 (형님, 여기가 핵심입니다)
    if (!name) return alert("이름을 입력해주세요.");
    if (!gender) return alert("성별을 선택해주세요.");
    if (!email) return alert("이메일을 입력해주세요.");
    if (email.indexOf('@') === -1) return alert("올바른 이메일 형식이 아닙니다.");
    if (!pw) return alert("비밀번호를 입력해주세요.");
    if (pw.length < 4) return alert("비밀번호는 최소 4자리 이상이어야 합니다.");
    if (!phone) return alert("전화번호를 입력해주세요.");
    if (!region) return alert("거주 지역을 선택해주세요.");
    if (!agree) return alert("개인정보 제공에 동의해주세요.");
    
    // 모든 체크 통과 시에만 기존 가입 함수 실행
    submitSignup(); 
}
document.addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        const activePage = document.querySelector('.page.active');
        if (activePage) {
            if (activePage.id === 'page-login') submitLogin();
            else if (activePage.id === 'page-signup') submitSignup();
        }
    }
});  
function switchHistoryTab(type) {
    const pointTab = document.getElementById('tab-point');
    const activityTab = document.getElementById('tab-activity');
    const pointSection = document.getElementById('history-point-section');
    const activitySection = document.getElementById('history-activity-section');

    if (type === 'point') {
        pointTab.className = 'flex-fill text-center py-2 active-tab';
        activityTab.className = 'flex-fill text-center py-2 inactive-tab';
        pointSection.style.display = 'block';
        activitySection.style.display = 'none';
    } else {
        pointTab.className = 'flex-fill text-center py-2 inactive-tab';
        activityTab.className = 'flex-fill text-center py-2 active-tab';
        pointSection.style.display = 'none';
        activitySection.style.display = 'block';
    }
}
async function loadUserHistory() {
    // 1. 탭 메뉴 구성 (포인트 / 활동)
    const historyHtml = `
        <div class="p-3">
            <div class="d-flex gap-2 mb-4 bg-white p-1 rounded-4 shadow-sm">
                <button class="btn w-50 rounded-4 fw-bold active-tab" id="tab-p" onclick="switchTab('p')">포인트 내역</button>
                <button class="btn w-50 rounded-4 fw-bold" id="tab-a" onclick="switchTab('a')">활동 신청</button>
            </div>
            
            <div id="history-content">
                </div>
        </div>
    `;
    document.getElementById('page-history').innerHTML = historyHtml;
    renderPointLogs(); // 기본값으로 포인트 내역 먼저 보여줌
}

// [포인트 내역 렌더링]
function renderPointLogs() {
    const container = document.getElementById('history-content');
    // userData.history는 서버에서 받아온 PointLogs 데이터
    if (!userData.history || userData.history.length === 0) {
        container.innerHTML = '<div class="text-center py-5 text-muted">포인트 내역이 없습니다.</div>';
        return;
    }

    container.innerHTML = userData.history.map(log => `
        <div class="dashboard-card mb-3 p-3 d-flex justify-content-between align-items-center">
            <div>
                <div class="fw-bold">${log.title}</div>
                <div class="small text-muted">${log.date}</div>
            </div>
            <div class="fw-bold ${log.amount > 0 ? 'text-primary' : 'text-danger'}">
                ${log.amount > 0 ? '+' : ''}${log.amount.toLocaleString()} P
            </div>
        </div>
    `).join('');
}

// [활동 신청 현황 렌더링]
function renderAppLogs() {
    const container = document.getElementById('history-content');
    if (!userData.applications || userData.applications.length === 0) {
        container.innerHTML = '<div class="text-center py-5 text-muted">신청 내역이 없습니다.</div>';
        return;
    }

    container.innerHTML = userData.applications.map(app => {
        let statusClass = 'bg-warning'; // 대기
        if(app.status === '승인') statusClass = 'bg-success';
        if(app.status === '반려') statusClass = 'bg-danger';

        return `
            <div class="dashboard-card mb-3 p-3">
                <div class="d-flex justify-content-between">
                    <div class="fw-bold">${app.title}</div>
                    <span class="badge ${statusClass}">${app.status}</span>
                </div>
                <div class="d-flex justify-content-between mt-2 align-items-end">
                    <div class="small text-muted">${app.date}</div>
                    <div class="fw-bold text-secondary">+${app.amount.toLocaleString()} P 예정</div>
                </div>
            </div>
        `;
    }).join('');
}
function syncTabBar(pageId) {
    document.querySelectorAll('.tab-item').forEach(tab => {
        tab.classList.remove('active');
    });

    let targetIdx = -1;
    if (pageId === 'page-main') targetIdx = 0;       // 홈
    else if (pageId === 'page-partners') targetIdx = 1; // [수정] 내역 -> 가맹점
    else if (pageId === 'page-guide') targetIdx = 2;    // 안내 (아이콘 순서에 따라 번호 조정 필요할 수 있음)
    // 원래 안내가 3번째였다면 그대로 두시면 됩니다.
    // (HTML 순서: 홈(0) - 가맹점(1) - 스캔버튼 - 안내(2) - 내정보(3))
    
    // 안내 페이지가 HTML상에서 4번째(인덱스 3)에 있다면 targetIdx = 3으로 잡아야 합니다.
    // 현재 HTML 구조상: 홈, 가맹점, (스캔버튼), 안내, 내정보 순이므로
    // 안내는 querySelectorAll('.tab-item') 했을 때 2번째 인덱스(0,1,2)가 맞습니다.
    
    else if (pageId === 'page-mypage') targetIdx = 3;   // 내정보

    const tabItems = document.querySelectorAll('.tab-item');
    if (targetIdx !== -1 && tabItems[targetIdx]) {
        tabItems[targetIdx].classList.add('active');
    }
}
function refreshUserData() {
    const saved = localStorage.getItem('gnpay_user');
    if (saved) userData = JSON.parse(saved);
}
function openMypage() {
    document.querySelector('.bottom-nav').style.transform = 'translateY(100%)'; // 하단바 숨기기
    showPage('page-mypage');
}

// 마이페이지 닫을 때 다시 보여주기
function closeMypage() {
    document.querySelector('.bottom-nav').style.transform = 'translateY(0)'; // 하단바 복구
    showPage('page-main');
}
// 가이드 슬라이더 실시간 카드 활성화 엔진
const guideSlider = document.getElementById('guide-slider-scroll');

if (guideSlider) {
    guideSlider.addEventListener('scroll', () => {
        const cards = guideSlider.querySelectorAll('.guide-card');
        const containerRect = guideSlider.getBoundingClientRect();
        // 기준점을 세로 중앙으로 변경
        const containerCenter = containerRect.top + containerRect.height / 2;

        cards.forEach((card) => {
            const cardRect = card.getBoundingClientRect();
            const cardCenter = cardRect.top + cardRect.height / 2;
            
            const distance = Math.abs(containerCenter - cardCenter);
            
            if (distance < 150) { // 중앙 기준 150px 이내면 활성화
                card.classList.add('active-focus');
            } else {
                card.classList.remove('active-focus');
            }
        });
    });
}
// --- 스와이프 화면 전환 엔진 시작 ---
let touchstartX = 0;
let touchendX = 0;
const tabOrder = ['page-main', 'page-history', 'page-guide', 'page-mypage'];

function handleGesture() {
    const swipeThreshold = 70;
    const activePage = document.querySelector('.page.active');
    
    // 팝업 열려있으면 중단
    if (document.getElementById('qr-focus-layer').style.display === 'flex' || 
        document.getElementById('scanner-modal').style.display === 'block') return;

    let currentIndex = tabOrder.indexOf(activePage?.id);
    if (currentIndex === -1) return;

    // 왼쪽 스와이프 (다음)
    if (touchstartX - touchendX > swipeThreshold) {
        let nextIndex = (currentIndex + 1) % tabOrder.length;
        executePageTransition(nextIndex);
    }
    // 오른쪽 스와이프 (이전)
    else if (touchendX - touchstartX > swipeThreshold) {
        let nextIndex = (currentIndex - 1 + tabOrder.length) % tabOrder.length;
        executePageTransition(nextIndex);
    }
}

// 부드러운 전환 실행 함수
function executePageTransition(index) {
    const nextPageId = tabOrder[index];
    
    // 탭바 아이콘 불 켜기 연동
    const tabs = document.querySelectorAll('.tab-item');
    if (tabs[index]) {
        // 내역 탭은 데이터 로딩이 필요하므로 기존 함수 활용
        if (nextPageId === 'page-history') loadActivityHistory();
        else showPage(nextPageId);
        
        // 탭바 아이콘 불 켜기
        updateTab(tabs[index]);
    }
}
function updateHarryCharacter(rank) {
    const badge = document.getElementById('harry-badge');
    const img = document.getElementById('harry-img');
    const walkingImg = document.getElementById('walking-harry'); // 산책로 캐릭터 추가
    
    if (!img) return;

    const rankData = {
        'GUEST': { img: '3dlog.png', color: 'linear-gradient(145deg, #ffffff, #e6e6e6)', text: '로그인 필요! 🔒', top: '-20px', left: '5px' },
        '보말': { img: 'r.png', color: 'linear-gradient(145deg, #ffdee9, #b5fffc)', text: '김녕 보말 🐚', top: '-10px', left: '10px' },
        '감자': { img: 'pote.png', color: 'linear-gradient(145deg, #e1b382, #c89666)', text: '김녕 감자 🥔', top: '-15px', left: '15px' },
        '당근': { img: 'ca.png', color: 'linear-gradient(145deg, #ff9a9e, #fecfef)', text: '김녕 당근 🥕', top: '-28px', left: '9px' },
        '돌고래': { img: 'dol.png', color: 'linear-gradient(145deg, #01b2ad, #00d2ff)', text: '김녕 돌고래 🐬', top: '-25px', left: '5px' },
        '해녀': { img: 'harry.png', color: 'linear-gradient(145deg, #667eea, #764ba2)', text: '전설의 해녀 👑', top: '-25px', left: '5px' }
    };

    const data = rankData[rank];
    if (data) {
        // 1. 우측 하단 둥둥 떠있는 정지 캐릭터
        img.src = `https://gnpay.my/${data.img}`;
        
        // 2. 하단 산책로 GIF 캐릭터 (파일명 규칙: r_walk.gif, pote_walk.gif 등)
        // GIF가 아직 없다면 정지 이미지(.png)를 그대로 보여주도록 예외처리함
        if (walkingImg) {
            const gifName = data.img.replace('.png', '_walk.gif');
            walkingImg.src = `https://gnpay.my/${gifName}`;
            
            // 만약 GIF가 없는 등급은 다시 정지 이미지로 빽(Back)
            walkingImg.onerror = function() {
                this.src = `https://gnpay.my/${data.img}`;
                this.onerror = null; 
            };
        }

        // 3. 뱃지 업데이트 (뱃지가 있을 때만 실행하여 에러 방지)
        if (badge) {
            badge.style.background = data.color;
            badge.style.color = (rank === 'GUEST' || rank === '보말') ? '#333' : '#fff';
            badge.innerText = data.text;
            badge.style.top = data.top;
            badge.style.left = data.left;
        }
    }
}
function getRankByPoints(points) {
    // 로그인이 안 되어 있거나 포인트가 없으면 게스트
    if (!userData.isLoggedIn || points === undefined || points === null) return 'GUEST'; 
    
    const p = Number(points);
    if (p >= 10000) return '해녀';
    if (p >= 5000)  return '돌고래';
    if (p >= 3000)  return '당근';
    if (p >= 1000)  return '감자';
    return '보말'; // 0~999 포인트
}
function openRankInfo() {
    // 1. 로그인 체크: 알림창 없이 바로 로그인 페이지로 슝!
    if (!userData || !userData.isLoggedIn) {
        showPage('page-login');
        return; 
    }

    const layer = document.getElementById('rank-info-layer');
    if (!layer) return;

    // 2. 데이터 준비
    const points = Number(userData.points || 0);
    const currentRankKey = getRankByPoints(points); 
    const name = userData.name || "사용자";
    
    const ranks = [
        { id: '보말', name: '김녕 보말 🐚', pt: 0, img: 'r.png', desc: '작고 소중한 김녕의 시작' },
        { id: '감자', name: '김녕 감자 🥔', pt: 1000, img: 'pote.png', desc: '포슬포슬 잘 익은 실천의 맛' },
        { id: '당근', name: '김녕 당근 🥕', pt: 3000, img: 'ca.png', desc: '땅 속 깊이 뿌리내린 진심' },
        { id: '돌고래', name: '김녕 돌고래 🐬', pt: 5000, img: 'dol.png', desc: '바다를 자유롭게 누비는 수호자' },
        { id: '해녀', name: '전설의 해녀 👑', pt: 10000, img: 'harry.png', desc: '바다와 하나가 된 살아있는 전설' }
    ];

    // 3. 사용자 정보 및 캐릭터 세팅 (스타일 포함)
    const nameEl = document.querySelector('#rank-info-layer #pop-user-name');
    if (nameEl) nameEl.innerText = name;
    
    const rankImgDisplay = document.querySelector('#rank-info-layer #pop-rank-img');
    if (rankImgDisplay) {
        rankImgDisplay.src = document.getElementById('harry-img').src;
        rankImgDisplay.style.width = '100px'; 
        rankImgDisplay.style.height = '100px';
        rankImgDisplay.style.objectFit = 'contain';
        rankImgDisplay.style.filter = 'drop-shadow(0 10px 15px rgba(0,0,0,0.15))';
        
        const parentBox = rankImgDisplay.parentElement;
        if (parentBox) {
            parentBox.style.background = 'none';
            parentBox.style.boxShadow = 'none';
            parentBox.style.padding = '0';
        }
    }

    // 4. 뱃지 색상 매핑
    const rankDataMap = {
        'GUEST':  { text: 'GIMNYEONG PAY', color: 'linear-gradient(145deg, #ffffff, #e6e6e6)', textColor: '#333' },
        '보말':   { text: '김녕 보말 🐚', color: 'linear-gradient(145deg, #ffdee9, #b5fffc)', textColor: '#333' },
        '감자':   { text: '김녕 감자 🥔', color: 'linear-gradient(145deg, #e1b382, #c89666)', textColor: '#fff' },
        '당근':   { text: '김녕 당근 🥕', color: 'linear-gradient(145deg, #ff9a9e, #fecfef)', textColor: '#fff' },
        '돌고래': { text: '김녕 돌고래 🐬', color: 'linear-gradient(145deg, #01b2ad, #00d2ff)', textColor: '#fff' },
        '해녀':   { text: '전설의 해녀 👑', color: 'linear-gradient(145deg, #667eea, #764ba2)', textColor: '#fff' }
    };

    const badge = document.querySelector('#rank-info-layer #pop-rank-badge');
    if (badge) {
        const data = rankDataMap[currentRankKey] || rankDataMap['GUEST'];
        badge.innerText = data.text;
        badge.style.background = data.color;
        badge.style.color = data.textColor;
        badge.style.display = 'inline-block';
        badge.style.padding = '4px 14px';
        badge.style.borderRadius = '15px';
        badge.style.fontSize = '0.75rem';
        badge.style.fontWeight = '900';
    }

    // 5. 게이지 바 및 다음 등급 텍스트 렌더링
    const gaugeBar = document.querySelector('#rank-info-layer #pop-gauge-bar');
    const gaugePercent = document.querySelector('#rank-info-layer #pop-gauge-percent');
    const nextInfoArea = document.querySelector('#rank-info-layer #pop-next-info');

    const nextRank = ranks.find(r => r.pt > points);
    const currentRankData = [...ranks].reverse().find(r => r.pt <= points);

    if (nextRank) {
        const range = nextRank.pt - currentRankData.pt;
        const progress = points - currentRankData.pt;
        const percent = Math.min(Math.floor((progress / range) * 100), 100);
        
        if (gaugeBar) {
            gaugeBar.style.width = '0%';
            setTimeout(() => { gaugeBar.style.width = percent + "%"; }, 50);
        }
        if (gaugePercent) gaugePercent.innerText = percent + "%";

        const nextData = rankDataMap[nextRank.id] || rankDataMap['GUEST'];

        if (nextInfoArea) {
            nextInfoArea.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 15px;">
                    <div style="text-align: left;">
                        <div style="color: #aaa; font-size: 0.65rem; font-weight: 800; letter-spacing: 0.5px; margin-bottom: 5px;">다음 등급</div>
                        <div style="display: inline-block; background: ${nextData.color}; color: ${nextData.textColor}; padding: 4px 14px; border-radius: 12px; font-size: 0.85rem; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                            ${nextRank.name}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #aaa; font-size: 0.65rem; font-weight: 800; letter-spacing: 0.5px; margin-bottom: 5px;">남은 포인트</div>
                        <div style="color: var(--primary); font-size: 1.2rem; font-weight: 900; line-height: 1;">
                            ${(nextRank.pt - points).toLocaleString()}<span style="font-size: 0.8rem; margin-left: 2px;">P</span>
                        </div>
                    </div>
                </div>
            `;
        }
    } else {
        if (gaugeBar) gaugeBar.style.width = "100%";
        if (gaugePercent) gaugePercent.innerText = "100%";
        if (nextInfoArea) {
            nextInfoArea.innerHTML = `<div style="margin-top: 15px; background: #1a1a1a; padding: 12px; border-radius: 18px; text-align: center; animation: pulse 1.5s infinite;"><span style="color: #FFD700; font-size: 1.1rem; font-weight: 900;">🏆현재 최고 등급 달성</span></div>`;
        }
    }

    // 6. 도감 리스트 생성
    let tableHtml = "";
    ranks.forEach(r => {
        const isCurrent = currentRankKey.includes(r.id);
        const isLocked = points < r.pt;
        tableHtml += `
            <div class="d-flex align-items-center gap-3 p-3 mb-2" style="border-radius:20px; background: ${isCurrent ? '#e6f7f6' : '#f8f9fa'}; border: 2px solid ${isCurrent ? 'var(--primary)' : 'transparent'}; opacity: ${isLocked ? '0.6' : '1'}">
                <img src="https://gnpay.my/${r.img}" style="width: 40px; height: 40px; object-fit: contain; filter: ${isLocked ? 'grayscale(100%)' : 'none'}">
                <div style="flex:1;">
                    <div class="fw-900" style="font-size:0.85rem; color:${isCurrent ? 'var(--primary)' : '#333'}">${r.name}</div>
                    <div class="text-muted" style="font-size:0.65rem;">${r.desc}</div>
                </div>
                <div class="text-end fw-bold" style="font-size:0.7rem; color:#888;">
                    ${r.pt === 0 ? '기본' : r.pt.toLocaleString() + 'P'}
                </div>
            </div>`;
    });
    
    const listEl = document.getElementById('rank-table-list');
    if (listEl) listEl.innerHTML = tableHtml;

    // 7. 레이어 표시
    layer.style.display = 'flex';
}
document.addEventListener('touchstart', e => {
    touchstartX = e.changedTouches[0].screenX;
}, {passive: true});

document.addEventListener('touchend', e => {
    touchendX = e.changedTouches[0].screenX;
    handleGesture();
}, {passive: true});
// 1. 탭 전환 (활동 기록 방식 계승)
function switchRankTab(type) {
    const todayTab = document.getElementById('tab-rank-today');
    const totalTab = document.getElementById('tab-rank-total');

    if (type === 'today') {
        todayTab.className = 'flex-fill text-center py-2 active-tab';
        totalTab.className = 'flex-fill text-center py-2 inactive-tab';
        loadRankingData('today');
    } else {
        todayTab.className = 'flex-fill text-center py-2 inactive-tab';
        totalTab.className = 'flex-fill text-center py-2 active-tab';
        loadRankingData('total');
    }
}

// 2. 랭킹 데이터 로드 (서버 연동용 프레임)
async function loadRankingData(mode) {
    const listContainer = document.getElementById('ranking-list');
    listContainer.innerHTML = '<div class="text-center p-5 small text-muted">순위를 집계 중입니다...</div>';

    try {
        const res = await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ type: 'getRanking', mode: mode })
        }).then(r => r.json());

        if (res.result === 'success' && res.data && res.data.length > 0) {
            renderRanking(res.data);
        } else {
            // 서버에 데이터가 없으면 샘플이라도 출력!
            throw new Error("No Data");
        }
    } catch (e) {
        console.log("랭킹 로드 실패, 샘플 데이터 가동");
        const sampleData = [
            { name: "해녀", points: 15000, rank: "해녀" },
            { name: "돌고래", points: 8500, rank: "돌고래" },
            { name: "당근", points: 5200, rank: "당근" },
            { name: "감자", points: 3100, rank: "감자" },
            { name: "보말", points: 1200, rank: "보말" }
        ];
        renderRanking(sampleData);
    }
}

// 3. 랭킹 렌더링 (디자인 핵심)
function renderRanking(data) {
    const listContainer = document.getElementById('ranking-list');
    const rankDataMap = {
        '보말': '🐚', '감자': '🥔', '당근': '🥕', '돌고래': '🐬', '해녀': '👑'
    };

    let html = '';
    data.forEach((user, idx) => {
        const isTop3 = idx < 3;
        const medal = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : (idx + 1);
        
        html += `
            <div class="dashboard-card mb-3" style="padding:15px 20px; animation: breathe 2s infinite ease-in-out; border-left: 5px solid ${isTop3 ? 'var(--primary)' : '#eee'};">
                <div class="d-flex align-items-center gap-3 w-100">
                    <div class="fw-900" style="font-size: 1.1rem; min-width: 30px; color: ${isTop3 ? 'var(--primary)' : '#888'};">
                        ${medal}
                    </div>
                    <div style="flex:1;">
                        <div class="fw-bold" style="font-size:1rem; color:#333;">${user.name}</div>
                        <div class="small text-muted" style="font-size:0.7rem;">${rankDataMap[user.rank] || '🐚'} ${user.rank} 등급</div>
                    </div>
                    <div class="text-end">
                        <div class="fw-900" style="color:var(--primary); font-size:1.1rem;">
                            ${user.points.toLocaleString()}<span style="font-size:0.75rem; margin-left:2px;">P</span>
                        </div>
                    </div>
                </div>
            </div>`;
    });
    listContainer.innerHTML = html;
}

</script>

</body>
</html>

