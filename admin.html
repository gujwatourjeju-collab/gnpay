<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>김녕페이 ADMIN 2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { --primary: #01b2ad; --primary-grad: linear-gradient(135deg, #01b2ad 0%, #00d2ff 100%); --bg-grad: linear-gradient(180deg, #e6f7f6 0%, #f8fcfc 40%, #ffffff 100%); }
        
        body { font-family: 'Pretendard', sans-serif; background: #f4f7f7; margin:0; padding: 0 0 100px 0; color: #1a1a1a; overflow-x: hidden; }
        
        /* 로그인 페이지 */
        #login-page { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-grad); z-index:20000; display:flex; flex-direction:column; justify-content:center; padding:40px; }
        .login-logo { width: 100px; margin-bottom: 10px; }
        .custom-input { border: none; border-radius: 16px; background: white; padding: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 15px; width: 100%; }
        .btn-grad { background: var(--primary-grad); color: white; border: none; padding: 18px; border-radius: 20px; font-weight: 800; width: 100%; box-shadow: 0 8px 20px rgba(1, 178, 173, 0.25); }

        /* 메인 헤더 & 네비 (3등분 꽉 차게) */
        .admin-header { padding: 25px 20px 10px; background: white; border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; }
        .admin-nav { display: flex; gap: 8px; padding: 15px; background: #f4f7f7; position: sticky; top: 0; z-index: 100; width: 100%; }
        .nav-btn { flex: 1; background: white; border: 1px solid #ddd; padding: 12px 5px; border-radius: 15px; font-weight: 700; color: #666; font-size: 0.85rem; text-align: center; }
        .nav-btn.active { background: var(--primary-grad); color: white; border: none; box-shadow: 0 5px 15px rgba(1, 178, 173, 0.3); }
        
        /* 리스트 카드 */
        .admin-card { background: white; margin: 0 15px 15px; padding: 18px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #eee; }
        .pending-img { width: 100%; border-radius: 12px; margin-top: 10px; border: 1px solid #eee; }
        .page { display: none; } .active { display: block; }
        
        /* 스캐너 풀스크린 */
        #scanner-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:30000; }
        #admin-reader { width:100%; height:100%; }
        .scanner-close-btn { position:absolute; bottom:50px; left:50%; transform:translateX(-50%); padding: 15px 40px; border-radius: 20px; background: white; border: none; font-weight: 800; z-index: 30001; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 10000; display: none; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>
    <div id="loading-overlay"><div class="spinner-border text-info"></div><div class="mt-2 fw-bold" style="color:var(--primary)">김녕 데이터 처리 중...</div></div>

    <div id="login-page">
        <div class="text-center mb-4">
            <img src="https://gnpay.my/log.png" class="login-logo">
            <h2 class="fw-bold mt-2" style="color:var(--primary)">김녕페이 ADMIN</h2>
            <p class="text-muted small">관리자 전용 제어 시스템</p>
        </div>
        <input type="email" id="admin-email" class="custom-input" placeholder="관리자 이메일">
        <input type="password" id="admin-pw" class="custom-input" placeholder="비밀번호">
        <button class="btn-grad" onclick="adminLogin()">관리 시스템 접속</button>
    </div>

    <div id="admin-content" style="display:none;">
        <div class="admin-header">
            <img src="https://gnpay.my/log.png" style="width: 60px;">
            <h5 class="fw-bold mt-2 mb-0" style="color:var(--primary)">김녕페이 관리 대시보드</h5>
            <div class="text-end px-3"><button class="btn btn-link text-danger text-decoration-none small" onclick="adminLogout()">로그아웃</button></div>
        </div>

        <div class="admin-nav">
            <button class="nav-btn active" id="btn-approval" onclick="showTab('approval')">신청 승인</button>
            <button class="nav-btn" id="btn-users" onclick="showTab('users')">회원 관리</button>
            <button class="nav-btn" id="btn-scanner" onclick="openScanner()">현장 스캐너</button>
        </div>

        <div id="tab-approval" class="page active">
            <div class="px-3 mb-3"><button class="btn btn-outline-info w-100 rounded-4 fw-bold" onclick="loadPendingActivities()">대기 내역 조회하기</button></div>
            <div id="pending-list" class="px-2"></div>
        </div>

        <div id="tab-users" class="page">
            <div class="px-3 mb-2"><input type="text" id="user-search" class="custom-input" placeholder="회원 이름 또는 고유코드" onkeyup="filterUsers()"></div>
            <div id="user-list" class="px-2"></div>
        </div>
    </div>

    <div id="scanner-modal">
        <div id="admin-reader"></div>
        <button class="scanner-close-btn" onclick="closeScanner()">닫기</button>
    </div>

    <div class="modal fade" id="scanResultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-5 shadow-lg">
                <div class="modal-body p-4 text-center">
                    <h5 class="fw-bold mb-1" id="scan-res-name">사용자명</h5>
                    <div class="badge bg-light text-dark mb-3" id="scan-res-uid">CODE</div>
                    <div class="bg-light p-3 rounded-4 mb-3">
                        <div class="small text-muted fw-bold">보유 포인트</div>
                        <div class="h3 fw-bold text-primary mb-0" id="scan-res-points">0</div>
                    </div>
                    <div class="input-group mb-3">
                        <input type="number" id="scan-adjust-amount" class="form-control form-control-lg border-0 bg-light" placeholder="변경할 포인트 (+/-)">
                        <button class="btn btn-primary px-4 fw-bold" onclick="adjustPointsFromScan()">적용</button>
                    </div>
                    <button class="btn btn-link text-muted text-decoration-none" data-bs-dismiss="modal">취소</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userEditModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-5 shadow-lg">
                <div class="modal-body p-4">
                    <h5 class="fw-bold mb-4" id="edit-user-name">정보 수정</h5>
                    <div class="small fw-bold text-muted mb-1">포인트 조정 (직접 입력)</div>
                    <input type="number" id="edit-points" class="custom-input mb-3">
                    <div class="small fw-bold text-muted mb-1">전화번호</div>
                    <input type="text" id="edit-phone" class="custom-input mb-3">
                    <div class="small fw-bold text-muted mb-1">소속</div>
                    <input type="text" id="edit-org" class="custom-input mb-3">
                    <button class="btn-grad mt-2" onclick="saveUserInfo()">수정 내용 저장</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx3n_w3jRXlNE1ht7zsg5WYv358AnGnFg61_AltbfPUnvlm7u3KjPtSRmDkAXrDPA/exec";
        const ADMIN_EMAILS = ["idamco@naver.com"];
        let allUsers = [];
        let html5QrCode;
        let scannedUid = "";
        let selectedUserEmail = "";

        window.onload = () => {
            const savedAdmin = localStorage.getItem('gn_admin_session');
            if(savedAdmin) {
                document.getElementById('login-page').style.display='none';
                document.getElementById('admin-content').style.display='block';
                loadUsers(); // 로그인 되어있으면 바로 유저 로드
            }
        };

        async function adminLogin() {
            const email = document.getElementById('admin-email').value;
            const pw = document.getElementById('admin-pw').value;
            if(!ADMIN_EMAILS.includes(email)) return alert("관리자 권한이 없습니다.");
            toggleLoading(true);
            try {
                const res = await fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'login', email, password:pw})}).then(r=>r.json());
                if(res.result === 'success') {
                    localStorage.setItem('gn_admin_session', email);
                    document.getElementById('login-page').style.display='none';
                    document.getElementById('admin-content').style.display='block';
                    loadUsers();
                } else alert("비밀번호가 틀립니다.");
            } catch(e) { alert("연결 오류"); }
            toggleLoading(false);
        }

        function adminLogout() { localStorage.removeItem('gn_admin_session'); location.reload(); }

        function showTab(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('active');
            if(id === 'users') loadUsers();
        }

        // 신청 승인 로직 (기능 복구)
        async function loadPendingActivities() {
            toggleLoading(true);
            try {
                const res = await fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'adminGetAllPending'})}).then(r=>r.json());
                const list = document.getElementById('pending-list');
                if(res.result === 'success' && res.pending.length > 0) {
                    list.innerHTML = res.pending.map(p => `
                        <div class="admin-card">
                            <div class="small text-muted mb-2">${p.date} | ${p.email}</div>
                            <div class="fw-bold fs-5">${p.title}</div>
                            <div class="text-primary fw-bold">+${p.amount.toLocaleString()}P 대기</div>
                            <div class="row g-2 mt-2">
                                ${p.img1 ? `<div class="col-6"><img src="${p.img1}" class="pending-img"></div>` : ''}
                                ${p.img2 ? `<div class="col-6"><img src="${p.img2}" class="pending-img"></div>` : ''}
                            </div>
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn btn-light flex-fill fw-bold rounded-3" onclick="handleActivity(${p.rowIdx}, 'reject')">반려</button>
                                <button class="btn btn-primary flex-fill fw-bold rounded-3" onclick="handleActivity(${p.rowIdx}, 'approve')">승인</button>
                            </div>
                        </div>`).join('');
                } else list.innerHTML = '<div class="text-center p-5">대기 내역이 없습니다.</div>';
            } catch(e) {}
            toggleLoading(false);
        }

        async function handleActivity(rowIdx, action) {
            if(!confirm(action === 'approve' ? "승인하시겠습니까?" : "반려하시겠습니까?")) return;
            toggleLoading(true);
            try {
                await fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'adminHandleActivity', rowIdx, action})});
                loadPendingActivities();
            } catch(e) {}
            toggleLoading(false);
        }

        // 회원 관리 & 수정 로직 (기능 복구)
        async function loadUsers() {
            toggleLoading(true);
            try {
                const res = await fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'adminGetUsers'})}).then(r=>r.json());
                if(res.result === 'success') { allUsers = res.users; renderUsers(allUsers); }
            } catch(e) {}
            toggleLoading(false);
        }

        function renderUsers(users) {
            document.getElementById('user-list').innerHTML = users.map(u => `
                <div class="admin-card" onclick="openUserEdit('${u.email}', '${u.name}', ${u.points}, '${u.phone}', '${u.org}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><div class="fw-bold">${u.name}</div><div class="small text-muted">${u.uid}</div></div>
                        <div class="fw-bold text-primary">${u.points.toLocaleString()}P</div>
                    </div>
                </div>`).join('');
        }

        function openUserEdit(email, name, points, phone, org) {
            selectedUserEmail = email;
            document.getElementById('edit-user-name').innerText = name + "님 정보 수정";
            document.getElementById('edit-points').value = points;
            document.getElementById('edit-phone').value = phone.replace("'", "");
            document.getElementById('edit-org').value = org || "";
            new bootstrap.Modal(document.getElementById('userEditModal')).show();
        }

        async function saveUserInfo() {
            toggleLoading(true);
            const data = { 
                type: 'adminUpdateUserFull', 
                email: selectedUserEmail, 
                points: document.getElementById('edit-points').value, 
                phone: document.getElementById('edit-phone').value, 
                org: document.getElementById('edit-org').value 
            };
            const res = await fetch(GAS_URL, {method:'POST', body:JSON.stringify(data)}).then(r=>r.json());
            if(res.result === 'success') {
                alert("수정 완료");
                bootstrap.Modal.getInstance(document.getElementById('userEditModal')).hide();
                loadUsers();
            }
            toggleLoading(false);
        }

        function filterUsers() {
            const val = document.getElementById('user-search').value.toLowerCase();
            const filtered = allUsers.filter(u => u.name.toLowerCase().includes(val) || u.uid.toLowerCase().includes(val));
            renderUsers(filtered);
        }

        // 스캐너 로직 (풀화면 팝업)
        function openScanner() {
            document.getElementById('scanner-modal').style.display = 'block';
            html5QrCode = new Html5Qrcode("admin-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                scannedUid = text;
                closeScanner();
                fetchUserInfoFromScan(text);
            }).catch(err => { alert("카메라를 열 수 없습니다."); closeScanner(); });
        }

        function closeScanner() {
            if(html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear());
            document.getElementById('scanner-modal').style.display = 'none';
        }

        async function fetchUserInfoFromScan(uid) {
            toggleLoading(true);
            try {
                const res = await fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'adminScanUser', uid: uid})}).then(r=>r.json());
                if(res.result === 'success') {
                    document.getElementById('scan-res-name').innerText = res.user.name;
                    document.getElementById('scan-res-uid').innerText = uid;
                    document.getElementById('scan-res-points').innerText = res.user.points.toLocaleString();
                    new bootstrap.Modal(document.getElementById('scanResultModal')).show();
                } else alert("존재하지 않는 사용자입니다.");
            } catch(e) {}
            toggleLoading(false);
        }

        async function adjustPointsFromScan() {
            const amt = document.getElementById('scan-adjust-amount').value;
            if(!amt) return alert("금액을 입력하세요.");
            toggleLoading(true);
            const res = await fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'adminScanUser', mode:'adjust', uid: scannedUid, amount: amt})}).then(r=>r.json());
            if(res.result === 'success') {
                alert(res.name + "님 처리완료: " + res.newPoints + "P");
                bootstrap.Modal.getInstance(document.getElementById('scanResultModal')).hide();
                document.getElementById('scan-adjust-amount').value = "";
                loadUsers();
            }
            toggleLoading(false);
        }

        function toggleLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
    </script>
</body>
</html>
