<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>김녕페이 ADMIN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { --primary: #01b2ad; --primary-grad: linear-gradient(135deg, #01b2ad 0%, #00d2ff 100%); }
        body { font-family: 'Pretendard', sans-serif; background: #f4f7f7; margin:0; padding: 20px 0 100px 0; color: #1a1a1a; }
        
        .admin-header { padding: 20px; background: white; border-radius: 0 0 30px 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .admin-nav { display: flex; gap: 10px; padding: 0 20px; margin-bottom: 20px; overflow-x: auto; }
        .nav-btn { background: white; border: 1px solid #eee; padding: 10px 20px; border-radius: 15px; font-weight: 700; white-space: nowrap; color: #666; }
        .nav-btn.active { background: var(--primary-grad); color: white; border: none; }
        
        .admin-card { background: white; margin: 0 20px 15px; padding: 20px; border-radius: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .user-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding: 15px 0; }
        
        .badge-status { padding: 4px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: 800; }
        .badge-pending { background: #fff3cd; color: #856404; }
        
        .btn-action { padding: 8px 15px; border-radius: 12px; font-weight: 800; border: none; font-size: 0.85rem; }
        .btn-approve { background: #e6f7f6; color: var(--primary); }
        .btn-reject { background: #fff0f0; color: #ff5b5b; }
        
        .search-bar { border: none; background: #eee; padding: 12px 20px; border-radius: 15px; width: 100%; margin-bottom: 15px; }
        .page { display: none; } .active { display: block; }

        /* 관리자 스캐너 구역 */
        #admin-reader { width: 100%; border-radius: 20px; overflow: hidden; background: #000; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 10000; display: none; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>
    <div id="loading-overlay"><div class="spinner-border text-info"></div><div class="mt-2 fw-bold">처리 중...</div></div>

    <div class="admin-header">
        <h4 class="fw-bold mb-0" style="color:var(--primary)">김녕페이 ADMIN <small class="text-muted" style="font-size:0.7rem">사장님 전용</small></h4>
    </div>

    <div class="admin-nav">
        <button class="nav-btn active" id="btn-approval" onclick="showTab('approval')">신청 승인</button>
        <button class="nav-btn" id="btn-users" onclick="showTab('users'); loadUsers();">회원 관리</button>
        <button class="nav-btn" id="btn-scanner" onclick="showTab('scanner')">현장 스캐너</button>
    </div>

    <div id="tab-approval" class="page active">
        <div class="px-3" id="pending-list">
            <div class="text-center mt-5 text-muted">불러오는 중...</div>
        </div>
    </div>

    <div id="tab-users" class="page">
        <div class="px-3">
            <input type="text" id="user-search" class="search-bar" placeholder="이름 또는 고유코드 검색" onkeyup="filterUsers()">
            <div id="user-list"></div>
        </div>
    </div>

    <div id="tab-scanner" class="page">
        <div class="px-3">
            <div id="admin-reader"></div>
            <div id="scan-result-card" class="admin-card mt-3" style="display:none;">
                <h5 id="scan-name" class="fw-bold">사용자명</h5>
                <p class="text-muted small mb-3">현재 보유: <span id="scan-points" class="fw-bold text-dark">0</span>P</p>
                <div class="input-group mb-3">
                    <input type="number" id="adjust-amount" class="form-control" placeholder="금액 (+/-)">
                    <button class="btn btn-primary" onclick="adjustPoints()">적용</button>
                </div>
                <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetScanner()">다시 스캔</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzqlbNrlp2CMtyyLuMbPzGkbafPacGKvqd9eY31UBnhuXZ8qzmG7MRE6G3Vt2BSWCKY/exec";
        let allUsers = [];
        let html5QrCode;
        let scannedUid = "";

        function showTab(tabId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('active');
            if(tabId === 'scanner') startScanner(); else stopScanner();
            if(tabId === 'approval') loadPendingActivities();
        }

        async function loadPendingActivities() {
            // 이 부분은 기존 getActivityHistory와 유사하지만 '대기' 상태인 모든 데이터를 가져오도록 GAS 보강 필요
            // 우선은 사장님이 시트에서 보시는 게 빠르니 회원관리와 스캐너 위주로 구현함
        }

        async function loadUsers() {
            const res = await fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'adminGetUsers'})}).then(r=>r.json());
            if(res.result === 'success') {
                allUsers = res.users;
                renderUsers(allUsers);
            }
        }

        function renderUsers(users) {
            const list = document.getElementById('user-list');
            list.innerHTML = users.map(u => `
                <div class="admin-card user-row">
                    <div>
                        <div class="fw-bold">${u.name}</div>
                        <div class="text-muted small">${u.uid}</div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-primary">${u.points.toLocaleString()}P</div>
                    </div>
                </div>
            `).join('');
        }

        function filterUsers() {
            const val = document.getElementById('user-search').value.toLowerCase();
            const filtered = allUsers.filter(u => u.name.toLowerCase().includes(val) || u.uid.toLowerCase().includes(val));
            renderUsers(filtered);
        }

        function startScanner() {
            html5QrCode = new Html5Qrcode("admin-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                scannedUid = text;
                fetchUserInfo(text);
                stopScanner();
            });
        }

        function stopScanner() { if(html5QrCode) html5QrCode.stop(); }

        async function fetchUserInfo(uid) {
            document.getElementById('loading-overlay').style.display='flex';
            const res = await fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'adminScanUser', uid: uid})}).then(r=>r.json());
            if(res.result === 'success') {
                document.getElementById('scan-result-card').style.display='block';
                document.getElementById('scan-name').innerText = res.user.name;
                document.getElementById('scan-points').innerText = res.user.points.toLocaleString();
            } else { alert("사용자를 찾을 수 없음"); startScanner(); }
            document.getElementById('loading-overlay').style.display='none';
        }

        async function adjustPoints() {
            const amt = document.getElementById('adjust-amount').value;
            if(!amt) return;
            document.getElementById('loading-overlay').style.display='flex';
            const res = await fetch(GAS_URL, {method:'POST', body:JSON.stringify({
                type:'adminScanUser', mode:'adjust', uid: scannedUid, amount: amt
            })}).then(r=>r.json());
            if(res.result === 'success') {
                alert(res.name + "님 포인트 조정 완료: " + res.newPoints);
                resetScanner();
            }
            document.getElementById('loading-overlay').style.display='none';
        }

        function resetScanner() {
            document.getElementById('scan-result-card').style.display='none';
            document.getElementById('adjust-amount').value = '';
            startScanner();
        }

        window.onload = () => loadPendingActivities();
    </script>
</body>
</html>